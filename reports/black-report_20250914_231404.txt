é”™è¯¯: would reformat /Users/shiyijiufei/TaifishingV4/app/services/connection_factory.py
would reformat /Users/shiyijiufei/TaifishingV4/app/utils/sqlserver_version_detector.py

Oh no! ğŸ’¥ ğŸ’” ğŸ’¥
2 files would be reformatted, 76 files would be left unchanged.


æ ‡å‡†è¾“å‡º:
--- /Users/shiyijiufei/TaifishingV4/app/services/connection_factory.py	2025-09-14 13:10:53.862953+00:00
+++ /Users/shiyijiufei/TaifishingV4/app/services/connection_factory.py	2025-09-14 15:14:05.993799+00:00
@@ -232,11 +232,11 @@
     def connect(self) -> bool:
         """å»ºç«‹SQL Serverè¿æ¥ - å°è¯•å¤šç§é©±åŠ¨å’Œç‰ˆæœ¬å…¼å®¹æ€§"""
         # è·å–è¿æ¥ä¿¡æ¯
         password = self.instance.credential.get_plain_password() if self.instance.credential else ""
         username = self.instance.credential.username if self.instance.credential else ""
-        
+
         database_name = (
             self.instance.database_name
             or DatabaseTypeUtils.get_database_type_config("sqlserver").default_schema
             or "master"
         )
@@ -273,11 +273,11 @@
 
     def _try_pyodbc_connection(self, username: str, password: str, database_name: str) -> bool:
         """å°è¯•ä½¿ç”¨pyodbcè¿æ¥ (æ¨èç”¨äºç°ä»£SQL Serverç‰ˆæœ¬)"""
         try:
             import pyodbc
-            
+
             # æ„å»ºè¿æ¥å­—ç¬¦ä¸² - æ”¯æŒå¤šç§ç‰ˆæœ¬
             connection_strings = [
                 # SQL Server 2012+ (æ¨è)
                 f"DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={self.instance.host},{self.instance.port};DATABASE={database_name};UID={username};PWD={password};TrustServerCertificate=yes;",
                 # SQL Server 2008-2019
@@ -285,67 +285,67 @@
                 # SQL Server 2005-2012 (ä¼ ç»Ÿ)
                 f"DRIVER={{SQL Server}};SERVER={self.instance.host},{self.instance.port};DATABASE={database_name};UID={username};PWD={password};",
                 # ä½¿ç”¨å‘½åç®¡é“ (æœ¬åœ°è¿æ¥)
                 f"DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={self.instance.host};DATABASE={database_name};UID={username};PWD={password};Trusted_Connection=no;",
             ]
-            
+
             for conn_str in connection_strings:
                 try:
                     self.connection = pyodbc.connect(conn_str, timeout=30)
                     self.is_connected = True
                     self.driver_type = "pyodbc"
                     return True
                 except Exception:
                     continue
-                    
+
             return False
-            
+
         except ImportError:
             return False
 
     def _try_pymssql_connection(self, username: str, password: str, database_name: str) -> bool:
         """å°è¯•ä½¿ç”¨pymssqlè¿æ¥ (é€‚ç”¨äºLinux/Unixç¯å¢ƒ)"""
         try:
             import pymssql
-            
+
             self.connection = pymssql.connect(
                 server=self.instance.host,
                 port=self.instance.port,
                 user=username,
                 password=password,
                 database=database_name,
                 timeout=30,
                 # æ·»åŠ ç‰ˆæœ¬å…¼å®¹æ€§å‚æ•°
-                tds_version='7.4',  # æ”¯æŒSQL Server 2005+
+                tds_version="7.4",  # æ”¯æŒSQL Server 2005+
             )
             self.is_connected = True
             self.driver_type = "pymssql"
             return True
-            
+
         except ImportError:
             return False
 
     def _try_pyodbc_legacy_connection(self, username: str, password: str, database_name: str) -> bool:
         """å°è¯•ä½¿ç”¨ä¼ ç»Ÿpyodbcè¿æ¥ (å…¼å®¹è€ç‰ˆæœ¬)"""
         try:
             import pyodbc
-            
+
             # ä¼ ç»Ÿè¿æ¥å­—ç¬¦ä¸²ï¼Œå…¼å®¹SQL Server 2005-2008
             legacy_conn_str = (
                 f"DRIVER={{SQL Server}};"
                 f"SERVER={self.instance.host},{self.instance.port};"
                 f"DATABASE={database_name};"
                 f"UID={username};"
                 f"PWD={password};"
                 f"Connection Timeout=30;"
             )
-            
+
             self.connection = pyodbc.connect(legacy_conn_str)
             self.is_connected = True
             self.driver_type = "pyodbc_legacy"
             return True
-            
+
         except ImportError:
             return False
 
     def disconnect(self) -> None:
         """æ–­å¼€SQL Serverè¿æ¥"""
--- /Users/shiyijiufei/TaifishingV4/app/utils/sqlserver_version_detector.py	2025-09-14 13:10:39.036114+00:00
+++ /Users/shiyijiufei/TaifishingV4/app/utils/sqlserver_version_detector.py	2025-09-14 15:14:06.007016+00:00
@@ -7,50 +7,106 @@
 from typing import Dict, Optional, Tuple
 
 
 class SQLServerVersionDetector:
     """SQL Serverç‰ˆæœ¬æ£€æµ‹å™¨"""
-    
+
     # SQL Serverç‰ˆæœ¬æ˜ å°„è¡¨
     VERSION_MAP = {
         # ç‰ˆæœ¬å· -> (ç‰ˆæœ¬åç§°, å¹´ä»½, æ”¯æŒçš„åŠŸèƒ½)
         "8.00": ("SQL Server 2000", 2000, ["basic"]),
         "9.00": ("SQL Server 2005", 2005, ["basic", "xml", "cte"]),
         "10.00": ("SQL Server 2008", 2008, ["basic", "xml", "cte", "merger"]),
         "10.50": ("SQL Server 2008 R2", 2010, ["basic", "xml", "cte", "merger", "compression"]),
         "11.00": ("SQL Server 2012", 2012, ["basic", "xml", "cte", "merger", "compression", "columnstore"]),
-        "12.00": ("SQL Server 2014", 2014, ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized"]),
-        "13.00": ("SQL Server 2016", 2016, ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized", "json", "temporal"]),
-        "14.00": ("SQL Server 2017", 2017, ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized", "json", "temporal", "graph"]),
-        "15.00": ("SQL Server 2019", 2019, ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized", "json", "temporal", "graph", "big_data"]),
-        "16.00": ("SQL Server 2022", 2022, ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized", "json", "temporal", "graph", "big_data", "ledger"]),
+        "12.00": (
+            "SQL Server 2014",
+            2014,
+            ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized"],
+        ),
+        "13.00": (
+            "SQL Server 2016",
+            2016,
+            ["basic", "xml", "cte", "merger", "compression", "columnstore", "memory_optimized", "json", "temporal"],
+        ),
+        "14.00": (
+            "SQL Server 2017",
+            2017,
+            [
+                "basic",
+                "xml",
+                "cte",
+                "merger",
+                "compression",
+                "columnstore",
+                "memory_optimized",
+                "json",
+                "temporal",
+                "graph",
+            ],
+        ),
+        "15.00": (
+            "SQL Server 2019",
+            2019,
+            [
+                "basic",
+                "xml",
+                "cte",
+                "merger",
+                "compression",
+                "columnstore",
+                "memory_optimized",
+                "json",
+                "temporal",
+                "graph",
+                "big_data",
+            ],
+        ),
+        "16.00": (
+            "SQL Server 2022",
+            2022,
+            [
+                "basic",
+                "xml",
+                "cte",
+                "merger",
+                "compression",
+                "columnstore",
+                "memory_optimized",
+                "json",
+                "temporal",
+                "graph",
+                "big_data",
+                "ledger",
+            ],
+        ),
     }
-    
+
     @classmethod
     def detect_version(cls, version_string: str) -> Dict[str, any]:
         """
         æ£€æµ‹SQL Serverç‰ˆæœ¬
-        
+
         Args:
             version_string: SQL Serverç‰ˆæœ¬å­—ç¬¦ä¸² (å¦‚ "Microsoft SQL Server 2019 (RTM-CU18) (KB5003279) - 15.0.4261.1 (X64)")
-            
+
         Returns:
             åŒ…å«ç‰ˆæœ¬ä¿¡æ¯çš„å­—å…¸
         """
         if not version_string:
             return cls._unknown_version()
-        
+
         # æå–ç‰ˆæœ¬å·
-        version_match = re.search(r'(\d+\.\d+)', version_string)
+        version_match = re.search(r"(\d+\.\d+)", version_string)
         if not version_match:
             return cls._unknown_version()
-        
+
         version_number = version_match.group(1)
-        
+
         # æŸ¥æ‰¾åŒ¹é…çš„ç‰ˆæœ¬
         for ver, (name, year, features) in cls.VERSION_MAP.items():
-            if version_string.startswith(ver) or version_number.startswith(ver.split('.')[0]):
+            if version_string.startswith(ver) or version_number.startswith(ver.split(".")[0]):
                 return {
                     "version_number": version_number,
                     "version_name": name,
                     "year": year,
                     "features": features,
@@ -60,13 +116,13 @@
                     "supports_temporal": "temporal" in features,
                     "supports_graph": "graph" in features,
                     "supports_columnstore": "columnstore" in features,
                     "supports_memory_optimized": "memory_optimized" in features,
                 }
-        
+
         # å¦‚æœæ²¡æ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•æ ¹æ®å¹´ä»½æ¨æ–­
-        year_match = re.search(r'(\d{4})', version_string)
+        year_match = re.search(r"(\d{4})", version_string)
         if year_match:
             year = int(year_match.group(1))
             if 2000 <= year <= 2022:
                 return {
                     "version_number": version_number,
@@ -79,13 +135,13 @@
                     "supports_temporal": year >= 2016,
                     "supports_graph": year >= 2017,
                     "supports_columnstore": year >= 2012,
                     "supports_memory_optimized": year >= 2014,
                 }
-        
+
         return cls._unknown_version()
-    
+
     @classmethod
     def _unknown_version(cls) -> Dict[str, any]:
         """è¿”å›æœªçŸ¥ç‰ˆæœ¬ä¿¡æ¯"""
         return {
             "version_number": "unknown",
@@ -98,38 +154,38 @@
             "supports_temporal": False,
             "supports_graph": False,
             "supports_columnstore": False,
             "supports_memory_optimized": False,
         }
-    
+
     @classmethod
     def get_recommended_driver(cls, version_info: Dict[str, any]) -> str:
         """
         æ ¹æ®ç‰ˆæœ¬ä¿¡æ¯æ¨èæœ€ä½³é©±åŠ¨
-        
+
         Args:
             version_info: ç‰ˆæœ¬ä¿¡æ¯å­—å…¸
-            
+
         Returns:
             æ¨èçš„é©±åŠ¨åç§°
         """
         if version_info["is_legacy"]:
             return "pymssql"  # è€ç‰ˆæœ¬æ¨èpymssql
         elif version_info["is_modern"]:
-            return "pyodbc"   # ç°ä»£ç‰ˆæœ¬æ¨èpyodbc
+            return "pyodbc"  # ç°ä»£ç‰ˆæœ¬æ¨èpyodbc
         else:
-            return "pyodbc"   # é»˜è®¤ä½¿ç”¨pyodbc
-    
+            return "pyodbc"  # é»˜è®¤ä½¿ç”¨pyodbc
+
     @classmethod
     def get_connection_string_template(cls, version_info: Dict[str, any], driver: str) -> str:
         """
         æ ¹æ®ç‰ˆæœ¬å’Œé©±åŠ¨è·å–è¿æ¥å­—ç¬¦ä¸²æ¨¡æ¿
-        
+
         Args:
             version_info: ç‰ˆæœ¬ä¿¡æ¯å­—å…¸
             driver: é©±åŠ¨åç§°
-            
+
         Returns:
             è¿æ¥å­—ç¬¦ä¸²æ¨¡æ¿
         """
         if driver == "pyodbc":
             if version_info["is_legacy"]:
@@ -141,35 +197,35 @@
         elif driver == "pymssql":
             # pymssqlè¿æ¥å‚æ•°
             return "server={server};port={port};user={username};password={password};database={database};tds_version=7.4"
         else:
             return ""
-    
+
     @classmethod
     def get_compatible_features(cls, version_info: Dict[str, any]) -> list[str]:
         """
         è·å–ç‰ˆæœ¬æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨
-        
+
         Args:
             version_info: ç‰ˆæœ¬ä¿¡æ¯å­—å…¸
-            
+
         Returns:
             æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨
         """
         features = []
-        
+
         if version_info["supports_json"]:
             features.append("JSONæ•°æ®ç±»å‹")
         if version_info["supports_temporal"]:
             features.append("æ—¶æ€è¡¨")
         if version_info["supports_graph"]:
             features.append("å›¾æ•°æ®åº“")
         if version_info["supports_columnstore"]:
             features.append("åˆ—å­˜å‚¨ç´¢å¼•")
         if version_info["supports_memory_optimized"]:
             features.append("å†…å­˜ä¼˜åŒ–è¡¨")
-        
+
         return features
 
 
 def test_version_detection():
     """æµ‹è¯•ç‰ˆæœ¬æ£€æµ‹åŠŸèƒ½"""
@@ -178,13 +234,13 @@
         "Microsoft SQL Server 2016 (SP2-CU17) (KB5001092) - 13.0.5888.11 (X64)",
         "Microsoft SQL Server 2012 (SP4-GDR) (KB4583465) - 11.0.7507.2 (X64)",
         "Microsoft SQL Server 2008 R2 (SP3-GDR) (KB4583465) - 10.50.6560.0 (X64)",
         "Microsoft SQL Server 2005 (SP4) - 9.00.5000.00 (X64)",
     ]
-    
+
     detector = SQLServerVersionDetector()
-    
+
     for version_str in test_versions:
         print(f"\nç‰ˆæœ¬å­—ç¬¦ä¸²: {version_str}")
         info = detector.detect_version(version_str)
         print(f"æ£€æµ‹ç»“æœ: {info['version_name']} ({info['year']})")
         print(f"æ¨èé©±åŠ¨: {detector.get_recommended_driver(info)}")
