# Website Development Specification (spec.md)

## 1. 项目概述 (Project Overview)

### 1.1 项目名称 (Project Name)
- **名称**: 泰摸鱼吧
- **描述**: 一个协助DBA工作的Web应用，用于管理数据库实例、凭据、账户信息，支持连接测试、模块化定时任务（独立账户同步模块，默认支持MySQL、Oracle、SQL Server，内置同步代码可调整）、系统全功能变更日志记录，集成Redis缓存优化性能，覆盖SQL Server、MySQL、Oracle数据库，未来可能扩展支持其他模块（如SSH账户、Windows账户、数据库/表/日志大小同步）。

### 1.2 项目目标 (Project Goals)
- **主要目标**: 提供DBA友好的工具，支持数据库实例管理、全局凭据管理、账户信息统计/搜索、模块化定时任务、系统变更日志记录，集成Redis缓存提升性能，预留扩展性以支持未来模块（如SSH/Windows账户、数据库/表/日志大小同步）。
- **次要目标**: 确保用户界面一致（账户搜索分数据库类型）、操作简单、安全可靠，支持SQL Server、MySQL、Oracle，适配桌面端现代化浏览器（如Chrome），生产和开发环境明确区分，前后端统一使用Flask以保持一致性。
- **目标用户**: DBA（管理员角色，管理实例、账户、日志、定时任务）及普通用户（查看信息）。

### 1.3 项目范围 (Project Scope)
- **包含范围**: 用户认证、角色权限、数据库实例管理（含连接测试及手动同步触发）、全局凭据管理、账户信息统计、账户搜索（分SQL Server/MySQL/Oracle页面）、模块化定时任务（独立账户同步模块，默认MySQL/Oracle/SQL Server）、系统变更日志记录，Redis缓存优化数据访问，预留扩展接口；全局参数模块统一管理关键可调整参数（如数据库类型、凭据类型）。
- **排除范围**: 不支持用户自助注册、不支持实时同步；不包括数据库运维操作（如备份、优化）；SSH/Windows账户、数据库/表/日志大小同步暂未实现；仅适配桌面端现代化浏览器（如Chrome）；不记录页面访问日志，仅记录变更操作；前后端统一使用Flask和Jinja2模板，无独立前端框架如React；移除元数据模块，所有关键参数放全局参数模块。
- **假设和约束**: 使用标准Web技术；支持SQL Server、MySQL、Oracle；凭据和权限信息加密存储；定时任务可靠运行；数据库模型支持扩展；前后端使用Flask（Jinja2模板渲染前端），纯Python生态以保持一致性；统一用Docker开发和部署；本地部署，软件版本考虑兼容性，避免最新版本；全局参数模块统一可配置；Redis缓存用于频繁访问数据；生产和开发环境分离；后端数据库使用PostgreSQL。

## 2. API 路径定义 (API Endpoints)

### 2.1 用户认证与管理 (User Authentication and Management)
- **API 路径**:
  - `POST /api/auth/login`: 用户登录，返回JWT令牌。
    - **请求**: `{ "username": string, "password": string }`
    - **响应**: `{ "token": string, "user_id": int, "role": string }`
    - **缓存**: JWT存储至Redis，键格式：`session:<user_id>`，TTL 1小时。
  - `POST /api/auth/forgot-password`: 发起密码重置请求。
    - **请求**: `{ "username": string }`
    - **响应**: `{ "message": string }`
  - `POST /api/auth/reset-password`: 重置密码。
    - **请求**: `{ "token": string, "new_password": string }`
    - **响应**: `{ "message": string }`
  - `GET /api/users`: 获取用户列表（管理员）。
    - **响应**: `[{ "id": int, "username": string, "role": string, "created_at": datetime, "last_login": datetime }, ...]`
    - **缓存**: 键`users:list`，TTL 10分钟。
  - `POST /api/users`: 添加用户（管理员）。
    - **请求**: `{ "username": string, "password": string, "role": string }`
    - **响应**: `{ "id": int, "username": string, "role": string }`
  - `PUT /api/users/<user_id>`: 编辑用户（管理员）。
    - **请求**: `{ "username": string, "password": string|null, "role": string }`
    - **响应**: `{ "id": int, "username": string, "role": string }`
  - `DELETE /api/users/<user_id>`: 删除用户（管理员，软删除）。
    - **响应**: `{ "message": string }`

### 2.2 数据库实例管理 (Database Instance Management)
- **API 路径**:
  - `GET /api/instances`: 获取实例列表。
    - **响应**: `[{ "id": int, "name": string, "db_type": string, "host": string, "port": int, "credential_id": int|null, "description": string|null, "tags": string[], "status": string }, ...]`
    - **缓存**: 键`instances:list`，TTL 10分钟。
  - `POST /api/instances`: 添加实例（管理员）。
    - **请求**: `{ "name": string, "db_type": string, "host": string, "port": int, "credential_id": int|null, "description": string|null, "tags": string[] }`
    - **响应**: `{ "id": int, "name": string, "db_type": string, ... }`
  - `GET /api/instances/<instance_id>`: 获取实例详情。
    - **响应**: `{ "id": int, "name": string, "db_type": string, ... }`
    - **缓存**: 键`instance:<instance_id>`，TTL 10分钟。
  - `PUT /api/instances/<instance_id>`: 编辑实例（管理员）。
    - **请求**: `{ "name": string, "db_type": string, "host": string, "port": int, "credential_id": int|null, "description": string|null, "tags": string[] }`
    - **响应**: `{ "id": int, "name": string, "db_type": string, ... }`
  - `DELETE /api/instances/<instance_id>`: 删除实例（管理员，软删除）。
    - **响应**: `{ "message": string }`
  - `POST /api/instances/<instance_id>/test`: 测试实例连接（管理员）。
    - **响应**: `{ "status": string, "message": string|null }`
  - `POST /api/sync/run/<instance_id>`: 手动触发同步（管理员）。
    - **响应**: `{ "status": string, "tasks_triggered": int, "message": string|null }`
    - **缓存**: 同步状态缓存至Redis，键`sync:status:<instance_id>`，TTL 10分钟。

### 2.3 凭据管理 (Credentials Management)
- **API 路径**:
  - `GET /api/credentials`: 获取凭据列表（密码掩码）。
    - **响应**: `[{ "id": int, "name": string, "credential_type": string, "db_type": string|null, "username": string, "instance_ids": int[], "category_id": int|null }, ...]`
    - **缓存**: 键`credentials:list`，TTL 10分钟。
  - `POST /api/credentials`: 添加凭据（管理员）。
    - **请求**: `{ "name": string, "credential_type": string, "db_type": string|null, "username": string, "password": string, "instance_ids": int[]|null }`
    - **响应**: `{ "id": int, "name": string, "credential_type": string, ... }`
  - `GET /api/credentials/<credential_id>`: 获取凭据详情（密码掩码）。
    - **响应**: `{ "id": int, "name": string, "credential_type": string, ... }`
    - **缓存**: 键`credential:<credential_id>`，TTL 10分钟。
  - `PUT /api/credentials/<credential_id>`: 编辑凭据（管理员）。
    - **请求**: `{ "name": string, "credential_type": string, "db_type": string|null, "username": string, "password": string|null, "instance_ids": int[]|null }`
    - **响应**: `{ "id": int, "name": string, "credential_type": string, ... }`
  - `DELETE /api/credentials/<credential_id>`: 删除凭据（管理员）。
    - **响应**: `{ "message": string }`

### 2.4 账户信息统计分析 (Account Information Statistics and Analysis)
- **API 路径**:
  - `GET /api/accounts/stats`: 获取账户统计。
    - **响应**: `{ "total": int, "by_db_type": { "<db_type>": int, ... }, "by_account_type": { "<type>": int, ... }, "by_category": { "<category>": int, ... }, "active_ratio": float }`
    - **缓存**: 键`account:stats:<user_id>`，TTL 5分钟。
  - `POST /api/accounts/stats/export`: 导出统计数据（CSV/PDF）。
    - **请求**: `{ "format": string }`
    - **响应**: `{ "file_url": string }`

### 2.5 账户信息筛选搜索 (Account Information Filter and Search)
- **API 路径**:
  - `GET /api/accounts/search/<db_type>`: 搜索账户（支持SQL Server/MySQL/Oracle）。
    - **查询参数**: `username`, `instance_name`, `account_type`, `permission`, `created_after`, `active_since`
    - **响应**: `[{ "id": int, "username": string, "db_type": string, "instance_id": int, "created_at": datetime, "last_active": datetime|null, "account_type_id": int|null, "permissions": json, "category_id": int|null }, ...]`
    - **缓存**: 键`account:search:<user_id>:<query_hash>`，TTL 5分钟。
  - `POST /api/accounts/search/<db_type>/export`: 导出搜索结果（CSV/PDF）。
    - **请求**: `{ "format": string, "filters": { ... } }`
    - **响应**: `{ "file_url": string }`

### 2.6 定时任务管理 (Scheduled Tasks Management)
- **API 路径**:
  - `GET /api/tasks`: 获取定时任务列表。
    - **响应**: `[{ "id": int, "instance_id": int, "sync_type": string, "db_type": string|null, "frequency": string, "time_window": string|null, "last_run": datetime|null, "status": string, "code": json|string }, ...]`
    - **缓存**: 键`tasks:list`，TTL 10分钟。
  - `POST /api/tasks`: 添加定时任务（管理员）。
    - **请求**: `{ "instance_id": int, "sync_type": string, "db_type": string|null, "frequency": string, "time_window": string|null, "code": json|string }`
    - **响应**: `{ "id": int, "instance_id": int, "sync_type": string, ... }`
  - `GET /api/tasks/<task_id>`: 获取任务详情。
    - **响应**: `{ "id": int, "instance_id": int, "sync_type": string, ... }`
    - **缓存**: 键`task:<task_id>`，TTL 10分钟。
  - `PUT /api/tasks/<task_id>`: 编辑任务（管理员）。
    - **请求**: `{ "instance_id": int, "sync_type": string, "db_type": string|null, "frequency": string, "time_window": string|null, "code": json|string }`
    - **响应**: `{ "id": int, "instance_id": int, "sync_type": string, ... }`
  - `DELETE /api/tasks/<task_id>`: 删除任务（管理员）。
    - **响应**: `{ "message": string }`
  - `POST /api/tasks/run/<task_id>`: 手动触发单个任务（管理员）。
    - **响应**: `{ "status": string, "message": string|null }`
    - **缓存**: 任务状态缓存至Redis，键`task:status:<task_id>`，TTL 10分钟。

### 2.7 全局参数管理 (Global Parameters Management)
- **API 路径**:
  - `GET /api/global-params`: 获取全局参数列表（如数据库类型、凭据类型）。
    - **响应**: `[{ "id": int, "param_type": string, "name": string, "config": json }, ...]`
    - **缓存**: 键`global-params:list`，TTL 1小时。
  - `POST /api/global-params`: 添加全局参数（管理员）。
    - **请求**: `{ "param_type": string, "name": string, "config": json }`
    - **响应**: `{ "id": int, "param_type": string, "name": string, ... }`
  - `PUT /api/global-params/<param_id>`: 编辑全局参数（管理员）。
    - **请求**: `{ "param_type": string, "name": string, "config": json }`
    - **响应**: `{ "id": int, "param_type": string, "name": string, ... }`
  - `DELETE /api/global-params/<param_id>`: 删除全局参数（管理员）。
    - **响应**: `{ "message": string }`

### 2.8 日志管理 (Log Management)
- **API 路径**:
  - `GET /api/logs`: 获取日志列表。
    - **查询参数**: `operation_type`, `user_id`, `start_time`, `end_time`, `status`
    - **响应**: `[{ "id": int, "operation_type": string, "user_id": int, "timestamp": datetime, "details": json, "status": string }, ...]`
    - **缓存**: 键`log:list:<query_hash>`，TTL 1天。
  - `POST /api/logs/export`: 导出日志（CSV/PDF）。
    - **请求**: `{ "format": string, "filters": { ... } }`
    - **响应**: `{ "file_url": string }`

## 3. 数据格式定义 (Data Formats)

### 3.1 通用格式
- **错误响应**: `{ "error": string, "message": string }`
- **分页响应**: `{ "data": array, "total": int, "page": int, "page_size": int }`
- **时间格式**: ISO 8601（如`2025-09-05T16:31:00Z`）。
- **JSON字段**: 权限、规则、配置等使用JSON存储，确保结构化且可扩展。

### 3.2 模块间数据流转
- **用户认证**:
  - 输入：`{ "username": string, "password": string }`
  - 输出：`{ "token": string, "user_id": int, "role": string }`
- **实例管理**:
  - 输入：`{ "name": string, "db_type": string, "host": string, "port": int, "credential_id": int|null, ... }`
  - 输出：`{ "id": int, "name": string, "db_type": string, ... }`
  - 同步触发：输入`instance_id`，输出`{ "status": string, "tasks_triggered": int }`.
- **凭据管理**:
  - 输入：`{ "name": string, "credential_type": string, "db_type": string|null, "username": string, "password": string, ... }`
  - 输出：`{ "id": int, "name": string, "credential_type": string, ... }`
- **账户统计**:
  - 输出：`{ "total": int, "by_db_type": { "<db_type>": int }, "by_account_type": { "<type>": int }, ... }`
- **账户搜索**:
  - 输入：查询参数（如`username`, `db_type`）。
  - 输出：`[{ "id": int, "username": string, "permissions": { "<permission>": boolean|string, ... }, ... }, ...]`
- **定时任务**:
  - 输入：`{ "instance_id": int, "sync_type": string, "db_type": string|null, "frequency": string, "code": json|string, ... }`
  - 输出：`{ "id": int, "instance_id": int, "sync_type": string, ... }`
  - 同步结果：`{ "task_id": int, "status": string, "data_count": int, "error": string|null }`
- **全局参数**:
  - 输入：`{ "param_type": string, "name": string, "config": { "<key>": value } }`
  - 输出：`[{ "id": int, "param_type": string, "name": string, ... }, ...]`
- **日志**:
  - 输出：`[{ "id": int, "operation_type": string, "user_id": int, "timestamp": datetime, "details": json, "status": string }, ...]`

## 4. 数据库表结构 (Database Schema)

### 4.1 表定义
- **Users**:
  - `id`: INT, 主键，自增
  - `username`: VARCHAR(255), 唯一，邮箱格式
  - `password`: VARCHAR(255), 加密（bcrypt）
  - `role`: VARCHAR(50), 默认user/admin
  - `created_at`: DATETIME
  - `last_login`: DATETIME, 可空
- **Instances**:
  - `id`: INT, 主键，自增
  - `name`: VARCHAR(255)
  - `db_type`: VARCHAR(50), 默认SQL Server/MySQL/Oracle
  - `host`: VARCHAR(255)
  - `port`: INT
  - `credential_id`: INT, 外键（Credentials.id），可空
  - `description`: TEXT, 可空
  - `tags`: JSON, 可空
  - `deleted_at`: DATETIME, 可空（软删除）
- **Credentials**:
  - `id`: INT, 主键，自增
  - `name`: VARCHAR(255)
  - `credential_type`: VARCHAR(50), 默认数据库/SSH/Windows
  - `db_type`: VARCHAR(50), 默认SQL Server/MySQL/Oracle，可空
  - `username`: VARCHAR(255)
  - `password`: VARCHAR(255), 加密（bcrypt）
  - `instance_ids`: JSON, 可空
  - `deleted_at`: DATETIME, 可空（软删除）
- **Accounts**:
  - `id`: INT, 主键，自增
  - `username`: VARCHAR(255)
  - `db_type`: VARCHAR(50), 默认SQL Server/MySQL/Oracle
  - `instance_id`: INT, 外键（Instances.id）
  - `created_at`: DATETIME
  - `last_active`: DATETIME, 可空
  - `permissions`: JSON, 完整权限列表
- **Account_Permissions**:
  - `account_id`: INT, 外键（Accounts.id）
  - `permission_name`: VARCHAR(255)
  - `scope`: VARCHAR(255), 可空（数据库/表）
  - 主键：`(account_id, permission_name, scope)`
- **Logs**:
  - `id`: INT, 主键，自增
  - `operation_type`: VARCHAR(50), enum（如user_create、instance_test）
  - `user_id`: INT, 外键（Users.id）
  - `timestamp`: DATETIME
  - `details`: JSON
  - `status`: VARCHAR(20), enum（success/failure）
- **Tasks**:
  - `id`: INT, 主键，自增
  - `instance_id`: INT, 外键（Instances.id）
  - `sync_type`: VARCHAR(50), 默认账户信息
  - `db_type`: VARCHAR(50), 默认SQL Server/MySQL/Oracle，可空
  - `frequency`: VARCHAR(255), Cron表达式
  - `time_window`: VARCHAR(255), 可空
  - `last_run`: DATETIME, 可空
  - `status`: VARCHAR(20), 可空
  - `log`: TEXT, 可空
  - `code`: JSON|TEXT, 同步逻辑
  - `deleted_at`: DATETIME, 可空（软删除）
- **Sync_Data**:
  - `id`: INT, 主键，自增
  - `sync_type`: VARCHAR(50), 默认账户信息
  - `instance_id`: INT, 外键（Instances.id）
  - `data`: JSON, 同步数据（如权限列表）
  - `sync_time`: DATETIME
- **Global_Params**:
  - `id`: INT, 主键，自增
  - `param_type`: VARCHAR(50), enum（数据库类型/凭据类型/同步类型/角色类型/其他）
  - `name`: VARCHAR(255)
  - `config`: JSON, （如驱动、模板）
  - `deleted_at`: DATETIME, 可空（软删除）

## 5. 功能需求 (Functional Requirements)

### 5.1 用户认证与管理 (User Authentication and Management)
- **描述**: 用户通过账户和密码登录，角色从全局参数配置，管理员管理用户，无自助注册。
- **细节**: 
  - 登录验证通过JWT，缓存至Redis（TTL 1小时）。
  - 管理员通过Flask模板管理用户，调用API。
  - 日志记录用户操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板，处理API请求。
  - 后端：Flask处理认证和CRUD，使用redis-py，纯JSON for API。

### 5.2 权限控制 (Permission Control)
- **描述**: 基于角色的访问控制（RBAC），角色从全局参数配置。
- **细节**: 
  - 普通用户只读，管理员全权限。
  - 前后端：Flask模板根据角色动态渲染。
  - 后端验证角色（Redis缓存，TTL 30分钟）。
  - 日志记录权限失败，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask+Jinja2根据角色隐藏/禁用控件。
  - 后端：Flask验证JWT和角色，返回403 for无权限。

### 5.3 主页与导航 (Homepage and Navigation)
- **描述**: 主页展示概览，分级导航菜单，置于Flask路由。
- **细节**: 
  - 导航菜单动态加载，缓存至Redis（TTL 1小时）。
  - 日志记录变更/同步相关点击，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板渲染菜单。
  - 后端：Flask返回菜单配置，检查Redis缓存。

### 5.4 数据库实例管理模块 (Database Instance Management Module)
- **描述**: 管理员管理实例（CRUD、连接测试、手动同步）。
- **细节**: 
  - 数据库类型从全局参数配置。
  - 手动同步触发所有匹配任务，状态缓存至Redis（TTL 10分钟）。
  - 日志记录操作，缓存至Redis（TTL 1天）。
  - 实例列表/详情缓存至Redis（TTL 10分钟）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板渲染列表/表单，处理API请求。
  - 后端：Flask处理CRUD、测试、同步，检查Redis缓存。

### 5.5 凭据管理界面 (Credentials Management Interface)
- **细节**: 
  - 凭据类型和数据库类型从全局参数配置。
  - 凭据列表/详情（密码掩码）缓存至Redis（TTL 10分钟）。
  - 日志记录操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板管理列表/表单，处理API请求。
  - 后端：Flask处理CRUD，检查Redis缓存。

### 5.6 账户信息统计分析界面 (Account Information Statistics and Analysis)
- **细节**: 
  - 统计结果缓存至Redis（TTL 5分钟）。
  - 日志记录导出操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板+Chart.js渲染统计。
  - 后端：Flask计算统计，检查Redis缓存。

### 5.7 账户信息筛选搜索界面 (Account Information Filter and Search)
- **细节**: 
  - 数据库类型从全局参数配置。
  - 搜索结果缓存至Redis（TTL 5分钟）。
  - 日志记录导出操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板管理搜索/筛选，处理API请求。
  - 后端：Flask处理查询，检查Redis缓存。

### 5.8 定时任务模块 (Scheduled Tasks Module)
- **细节**: 
  - 同步类型和数据库类型从全局参数配置。
  - 任务状态和结果缓存至Redis（TTL 10分钟）。
  - 日志记录操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板（CodeMirror编辑代码）管理任务。
  - 后端：Flask Blueprint+Celery处理任务，检查Redis缓存。

### 5.9 全局参数模块 (Global Parameters Management Module)
- **描述**: 统一管理关键可调整的参数（如数据库类型、凭据类型、同步类型、角色类型），置于系统管理下，支持CRUD。
- **细节**: 
  - 参数缓存至Redis（TTL 1小时）。
  - 日志记录操作，缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板（CodeMirror for代码模板）管理参数。
  - 后端：Flask处理CRUD，检查Redis缓存。

### 5.10 日志管理模块 (Log Management Module)
- **细节**: 
  - 近期日志缓存至Redis（TTL 1天）。
- **实现**:
  - 前后端：Flask路由+Jinja2模板管理日志显示/搜索。
  - 后端：Flask处理查询/导出，检查Redis缓存。

## 6. 非功能需求 (Non-Functional Requirements)

### 6.1 性能 (Performance)
- **响应时间**: 页面加载 < 2秒，搜索/统计 < 5秒，连接测试 < 10秒，手动同步 < 1分钟。
- **并发用户**: 支持至少100同时在线。
- **同步性能**: 单次同步 < 1分钟。
- **缓存性能**: Redis命中率 >80%，查询 <10ms。

### 6.2 安全性 (Security)
- **措施**: HTTPS、bcrypt/AES加密、防止SQL注入/XSS/CSRF、最低权限账户、JWT认证、Redis密码保护。
- **合规**: GDPR。

### 6.3 可访问性 (Accessibility)
- **标准**: WCAG 2.1，高危账户红色高亮注意色盲用户。
- **适配**: Chrome 90+。

### 6.4 技术栈 (Technology Stack)
- **前后端**: Flask 2.0.3（Python 3.8.10），使用Jinja2 3.0.3模板渲染前端，禁用独立前端框架如React。
- **驱动**: pymssql 2.2.5/pyodbc 4.0.32, pymysql 1.0.2/mysql-connector-python 8.0.29, cx_Oracle 8.3.0。
- **数据库**: PostgreSQL 13.5。
- **缓存**: Redis 4.0.2。
- **定时任务**: Celery 5.2.7+Redis 4.0.2。
- **部署**: 统一用Docker开发和部署（Docker 20.10.12，Docker Compose 1.29.2）。
- **测试**: pytest 6.2.5（用于单元/集成测试），Flask-Testing 0.8.1。

## 7. 环境要求 (Environment Requirements)

### 7.1 生产环境
- **硬件**: 专用服务器（x86_64，8核CPU，16GB RAM，500GB SSD，RAID1冗余）。
- **操作系统**: Ubuntu 20.04 LTS。
- **网络**: 防火墙限制，仅开放80（HTTP）、443（HTTPS）、6379（Redis，限制本地IP）。
- **配置**:
  - Docker: 统一容器化，Flask+Gunicorn运行，端口8000。
  - PostgreSQL: Docker容器，加密字段，每日备份。
  - Redis: Docker容器，密码保护，持久化（AOF）。
  - Celery: Docker容器，2 worker，beat调度，Redis作为broker。
- **监控**: 系统日志、Redis命中率、数据库性能、Celery任务状态。
- **备份**: 数据库每日备份，Redis AOF快照，同步代码和参数每周备份。

### 7.2 开发环境
- **硬件**: 单机（x86_64，4核CPU，8GB RAM，100GB SSD）。
- **操作系统**: Ubuntu 20.04 LTS。
- **网络**: 本地开发，开放80、443、6379（仅localhost）。
- **配置**:
  - Docker: 统一容器化，Flask+Gunicorn运行，端口8000。
  - PostgreSQL: Docker容器，测试数据，禁用加密以简化开发。
  - Redis: Docker容器，无密码，禁用持久化以降低开销。
  - Celery: Docker容器，1 worker，beat调度，Redis作为broker。
- **工具**: VSCode，Postman（API测试）。

## 8. 测试与部署 (Testing and Deployment)

### 8.1 测试计划 (Testing Plan)
- 单元测试：模块功能（用户、实例、凭据、任务、日志）。
- 集成测试：API端点、数据流转、Redis缓存、Celery任务。
- 权限测试：普通用户变更或同步被拒。
- 跨数据库测试：SQL Server/MySQL/Oracle一致性和权限完整性。
- 缓存测试：Redis命中率、失效机制、性能（<10ms）。
- 环境测试：生产和开发环境配置一致性。
- 兼容性测试：验证技术栈版本在Ubuntu 20.04的稳定性。
- API测试：验证Flask API端点（JSON响应，无模板渲染）。
- 模板测试：验证Jinja2渲染一致性。

### 8.2 部署计划 (Deployment Plan)
- **Docker开发**: 使用Dockerfile构建Flask镜像，Docker Compose启动服务（Flask、PostgreSQL、Redis、Celery）。
- **Docker部署**: Docker Compose生产配置文件（volume持久化），手动运行或脚本启动。
- **生产**: 单服务器，Docker Compose up -d，定期备份。
- **开发**: 单机，Docker Compose up -d，简化配置。
- **CI/CD**: Jenkins/GitLab CI，自动化测试和Docker构建。

## 9. 测试脚本 (Testing Scripts)
- **描述**: 建立一整套测试脚本，使用pytest和Flask-Testing，可以手动调用（python -m pytest），抓取console日志方便调试。
- **脚本结构**:
  - **unit_tests.py**: 单元测试（e.g., 函数、模型）。
  - **integration_tests.py**: 集成测试（e.g., API端点、数据库交互）。
  - **cache_tests.py**: Redis缓存测试。
  - **task_tests.py**: Celery任务测试。
  - **log_capture**: 使用caplog抓取console日志，输出格式：`[INFO] message`。
- **手动调用**: `python -m pytest --capture=tee-sys`（抓取stdout/stderr日志）。
- **实现**:
  - 使用pytest-fixture设置测试客户端（app.test_client()）。
  - 日志：app.logger.info("Test message")，caplog.records检查。
  - 覆盖率：pytest-cov报告。

## 10. 时间表与里程碑 (Timeline and Milestones)
- **阶段**: 需求收集（当前）、设计、开发、测试、上线。
- **预计时间**: 未指定。请提供预期周期。

## 11. 预算与资源 (Budget and Resources)
- **预算**: 未指定。
- **团队**: 开发者（Flask+Python）、设计师（可选）、系统管理员。

## 12. 风险与缓解 (Risks and Mitigations)
- **风险**: 多数据库兼容性、凭据安全、同步性能、日志数据量、Redis配置错误。
- **缓解**: 使用成熟驱动、加密和审计、优化查询、日志分表、Redis密码保护和监控。

## 13. Flask插件集成 (Flask Extensions Integration)
- **flask-cli**: 用于自定义CLI命令，如数据库初始化、同步任务运行、数据迁移。
- **flask-debugtoolbar**: 开发环境调试工具栏，监控请求、SQL查询、性能。
- **flask-wtf**: 表单处理和CSRF保护，用于登录、添加实例、凭据表单。
- **flask-login**: 用户认证和会话管理，处理登录/登出、角色检查。
- **flask-restful**: 构建REST API端点，如 /api/users, /api/instances 等。
- **flask-admin**: 管理界面，用于CRUD操作如用户、实例、凭据、全局参数管理，提供现成后台。
- **flask-sqlalchemy**: 集成SQLAlchemy ORM，提供数据库操作支持，避免手动SQL查询。
- **flask-migrate**: 数据库迁移工具，基于Alembic，用于表结构变更。
- **flask-cors**: 处理跨域资源共享，如果有AJAX请求。
- **flask-jwt-extended**: 增强JWT认证支持，用于API安全。
- **flask-bcrypt**: 密码哈希工具，用于用户密码加密。
- **flask-cache**: 缓存支持，集成Redis，用于数据缓存。
- **flask-limiter**: 速率限制工具，防止API滥用。
- **flask-principal**: 权限管理扩展，用于RBAC。
- **flask-security**: 综合认证和授权框架，增强安全特性。
- **flask-testing**: 测试扩展，支持unittest，用于单元测试。