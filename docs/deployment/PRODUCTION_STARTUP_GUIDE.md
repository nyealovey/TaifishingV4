# é²¸è½ - ç”Ÿäº§ç¯å¢ƒå¯åŠ¨æŒ‡å—

## ğŸš¨ é‡è¦è¯´æ˜

**å½“å‰Dockeré•œåƒå†…éƒ¨å¯åŠ¨æ–¹å¼å­˜åœ¨é—®é¢˜ï¼**

### âŒ å½“å‰é—®é¢˜

1. **ä½¿ç”¨Flaskå¼€å‘æœåŠ¡å™¨**: `CMD ["python", "app.py"]` ç›´æ¥å¯åŠ¨Flaskå¼€å‘æœåŠ¡å™¨
2. **ç¼ºå°‘WSGIæœåŠ¡å™¨**: æ²¡æœ‰å®‰è£…Gunicornã€uWSGIç­‰ç”Ÿäº§çº§WSGIæœåŠ¡å™¨
3. **å•çº¿ç¨‹è¿è¡Œ**: Flaskå¼€å‘æœåŠ¡å™¨ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
4. **ç¼ºå°‘è¿›ç¨‹ç®¡ç†**: æ²¡æœ‰ä½¿ç”¨supervisorç­‰è¿›ç¨‹ç®¡ç†å·¥å…·

### âœ… è§£å†³æ–¹æ¡ˆ

æˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š

## ğŸ—ï¸ ç”Ÿäº§ç¯å¢ƒæ¶æ„

### 1. WSGIæœåŠ¡å™¨
- **Gunicorn**: ç”Ÿäº§çº§WSGI HTTPæœåŠ¡å™¨
- **Gevent**: å¼‚æ­¥å·¥ä½œæ¨¡å¼ï¼Œæ”¯æŒé«˜å¹¶å‘
- **å¤šè¿›ç¨‹**: æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®å·¥ä½œè¿›ç¨‹

### 2. è¿›ç¨‹ç®¡ç†
- **Supervisor**: ç®¡ç†å¤šä¸ªè¿›ç¨‹ï¼ˆåº”ç”¨+è°ƒåº¦å™¨ï¼‰
- **è‡ªåŠ¨é‡å¯**: è¿›ç¨‹å´©æºƒæ—¶è‡ªåŠ¨é‡å¯
- **æ—¥å¿—ç®¡ç†**: ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†å’Œç®¡ç†

### 3. æ€§èƒ½ä¼˜åŒ–
- **è¿æ¥æ± **: æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜é…ç½®
- **èµ„æºé™åˆ¶**: å†…å­˜å’ŒCPUä½¿ç”¨é™åˆ¶

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. ç”Ÿäº§ç¯å¢ƒä¾èµ–
```
requirements-prod.txt          # ç”Ÿäº§ç¯å¢ƒPythonä¾èµ–
â”œâ”€â”€ gunicorn==21.2.0          # WSGIæœåŠ¡å™¨
â”œâ”€â”€ gevent==23.9.1            # å¼‚æ­¥å·¥ä½œæ¨¡å¼
â”œâ”€â”€ supervisor==4.2.5         # è¿›ç¨‹ç®¡ç†
â””â”€â”€ prometheus-client==0.19.0 # ç›‘æ§æ”¯æŒ
```

### 2. ç”Ÿäº§ç¯å¢ƒé…ç½®
```
Dockerfile.prod               # ç”Ÿäº§ç¯å¢ƒDockerfile
â”œâ”€â”€ å®‰è£…ç”Ÿäº§ç¯å¢ƒä¾èµ–
â”œâ”€â”€ é…ç½®Gunicorn
â”œâ”€â”€ é…ç½®Supervisor
â””â”€â”€ å¤šè¿›ç¨‹å¯åŠ¨

wsgi.py                       # WSGIå…¥å£æ–‡ä»¶
â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒåº”ç”¨å…¥å£
â””â”€â”€ Gunicornå¯åŠ¨ç‚¹

app/config.py                 # ç»Ÿä¸€é…ç½®ç±»ï¼ˆæ”¯æŒå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒï¼‰
â”œâ”€â”€ æ€§èƒ½ä¼˜åŒ–é…ç½®
â”œâ”€â”€ å®‰å…¨é…ç½®
â””â”€â”€ ç›‘æ§é…ç½®
```

### 3. å¯åŠ¨è„šæœ¬
```
scripts/start-prod.sh         # ç”Ÿäº§ç¯å¢ƒå¯åŠ¨è„šæœ¬
â”œâ”€â”€ ç¯å¢ƒæ£€æŸ¥
â”œâ”€â”€ ä¾èµ–æœåŠ¡ç­‰å¾…
â”œâ”€â”€ æ•°æ®åº“è¿ç§»
â””â”€â”€ Gunicornå¯åŠ¨
```

## ğŸš€ æ­£ç¡®çš„ç”Ÿäº§ç¯å¢ƒå¯åŠ¨æ–¹å¼

### 1. æ„å»ºç”Ÿäº§ç¯å¢ƒé•œåƒ

```bash
# ä½¿ç”¨æ–°çš„ç”Ÿäº§ç¯å¢ƒDockerfile
docker build -f Dockerfile.prod -t whalefall:latest .

# æˆ–è€…ä½¿ç”¨æ„å»ºè„šæœ¬
./scripts/build-image.sh latest
```

### 2. å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰
./scripts/deploy.sh prod start

# æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
docker compose -f docker-compose.prod.yml up -d
```

### 3. éªŒè¯ç”Ÿäº§ç¯å¢ƒ

```bash
# æ£€æŸ¥è¿›ç¨‹
docker exec -it whalefall_app ps aux

# åº”è¯¥çœ‹åˆ°ï¼š
# - gunicornä¸»è¿›ç¨‹
# - å¤šä¸ªgunicornå·¥ä½œè¿›ç¨‹
# - supervisorè¿›ç¨‹
# - è°ƒåº¦å™¨è¿›ç¨‹

# æ£€æŸ¥æ—¥å¿—
docker logs whalefall_app

# åº”è¯¥çœ‹åˆ°Gunicornå¯åŠ¨æ—¥å¿—ï¼Œè€Œä¸æ˜¯Flaskå¼€å‘æœåŠ¡å™¨æ—¥å¿—
```

## ğŸ”§ ç”Ÿäº§ç¯å¢ƒç‰¹æ€§

### 1. é«˜å¹¶å‘æ”¯æŒ
```python
# Gunicorné…ç½®
workers = multiprocessing.cpu_count() * 2 + 1  # å·¥ä½œè¿›ç¨‹æ•°
worker_class = "gevent"                        # å¼‚æ­¥å·¥ä½œæ¨¡å¼
worker_connections = 1000                      # æ¯ä¸ªå·¥ä½œè¿›ç¨‹è¿æ¥æ•°
```

### 2. è¿›ç¨‹ç®¡ç†
```ini
# Supervisoré…ç½®
[program:whalefall]
command=/app/.venv/bin/gunicorn --config /app/gunicorn.conf.py wsgi:application
autostart=true
autorestart=true

[program:whalefall-scheduler]
command=/app/.venv/bin/python -c "from app.scheduler import start_scheduler; start_scheduler()"
autostart=true
autorestart=true
```

### 3. æ€§èƒ½ç›‘æ§
```python
# èµ„æºé™åˆ¶
deploy:
  resources:
    limits:
      memory: 1G
      cpus: '1.0'
    reservations:
      memory: 512M
      cpus: '0.5'
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| ç‰¹æ€§ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|----------|----------|
| æœåŠ¡å™¨ | Flaskå¼€å‘æœåŠ¡å™¨ | Gunicorn + Gevent |
| è¿›ç¨‹æ•° | 1ä¸ª | å¤šè¿›ç¨‹ï¼ˆCPUæ ¸å¿ƒæ•°Ã—2+1ï¼‰ |
| å¹¶å‘æ”¯æŒ | å•çº¿ç¨‹ | é«˜å¹¶å‘å¼‚æ­¥ |
| è¿›ç¨‹ç®¡ç† | æ—  | Supervisor |
| è‡ªåŠ¨é‡å¯ | æ—  | æœ‰ |
| èµ„æºé™åˆ¶ | æ—  | æœ‰ |
| ç›‘æ§æ”¯æŒ | åŸºç¡€ | å®Œæ•´ |

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
```bash
# è¿›å…¥å®¹å™¨
docker exec -it whalefall_app bash

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep -E "(gunicorn|supervisor|python)"

# åº”è¯¥çœ‹åˆ°å¤šä¸ªè¿›ç¨‹åœ¨è¿è¡Œ
```

### 2. æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹Gunicornæ—¥å¿—
tail -f /app/userdata/logs/gunicorn_access.log
tail -f /app/userdata/logs/gunicorn_error.log

# æŸ¥çœ‹Supervisoræ—¥å¿—
tail -f /app/userdata/logs/supervisord.log
```

### 3. æ€§èƒ½ç›‘æ§
```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats whalefall_app

# æŸ¥çœ‹è¿æ¥æ•°
docker exec -it whalefall_app netstat -an | grep :5000
```

## ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- å¢åŠ è¿æ¥æ± å¤§å°
-- é…ç½®ç´¢å¼•
-- å¯ç”¨æŸ¥è¯¢ç¼“å­˜
```

### 2. Redisä¼˜åŒ–
```bash
# é…ç½®å†…å­˜é™åˆ¶
# å¯ç”¨æŒä¹…åŒ–
# é…ç½®æ·˜æ±°ç­–ç•¥
```

### 3. Nginxä¼˜åŒ–
```nginx
# å¯ç”¨gzipå‹ç¼©
# é…ç½®é™æ€æ–‡ä»¶ç¼“å­˜
# è®¾ç½®è¶…æ—¶æ—¶é—´
```

## ğŸ¯ æ€»ç»“

ç°åœ¨æ‚¨çš„Dockeré•œåƒå·²ç»é…ç½®äº†çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒè§£å†³æ–¹æ¡ˆï¼š

1. âœ… **WSGIæœåŠ¡å™¨**: ä½¿ç”¨Gunicornæ›¿ä»£Flaskå¼€å‘æœåŠ¡å™¨
2. âœ… **å¤šè¿›ç¨‹æ”¯æŒ**: æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®å·¥ä½œè¿›ç¨‹
3. âœ… **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨Geventæ”¯æŒé«˜å¹¶å‘
4. âœ… **è¿›ç¨‹ç®¡ç†**: ä½¿ç”¨Supervisorç®¡ç†å¤šä¸ªè¿›ç¨‹
5. âœ… **è‡ªåŠ¨é‡å¯**: è¿›ç¨‹å´©æºƒæ—¶è‡ªåŠ¨é‡å¯
6. âœ… **èµ„æºé™åˆ¶**: é™åˆ¶å†…å­˜å’ŒCPUä½¿ç”¨
7. âœ… **ç›‘æ§æ”¯æŒ**: å®Œæ•´çš„æ—¥å¿—å’Œç›‘æ§

**è¯·ä½¿ç”¨æ–°çš„Dockerfile.prodé‡æ–°æ„å»ºé•œåƒï¼Œä»¥è·å¾—çœŸæ­£çš„ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ï¼**
