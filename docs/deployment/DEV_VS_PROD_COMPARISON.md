# 🔄 开发环境 vs 生产环境配置对比

## 📋 概述

本文档详细对比鲸落项目开发环境和生产环境的配置差异，帮助开发团队理解两个环境的不同配置和优化策略。

## 🏗️ 架构对比

### 服务架构

| 组件 | 开发环境 | 生产环境 | 差异说明 |
|------|----------|----------|----------|
| **基础镜像** | Ubuntu 22.04 | Ubuntu 22.04 | 相同 |
| **Python版本** | 3.11 | 3.11 | 相同 |
| **包管理器** | uv | uv | 相同 |
| **数据库** | PostgreSQL 15-alpine | PostgreSQL 15-alpine | 相同 |
| **缓存** | Redis 7-alpine | Redis 7-alpine | 相同 |
| **Web服务器** | Nginx + Gunicorn | Nginx + Gunicorn | 相同 |

### 容器配置

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **容器命名** | `*_dev` | `*_prod` | 环境隔离 |
| **网络名称** | `whalefall_dev_network` | `whalefall_prod_network` | 避免冲突 |
| **数据卷** | `whalefall_*_data` | `whalefall_*_data` | 相同命名 |

## 🐳 Docker配置对比

### 1. Docker Compose配置

#### 服务配置差异

| 配置项 | 开发环境 | 生产环境 | 差异说明 |
|--------|----------|----------|----------|
| **数据库名** | `whalefall_dev` | `whalefall_prod` | 环境隔离 |
| **容器名** | `whalefall_postgres_dev` | `whalefall_postgres_prod` | 避免冲突 |
| **端口暴露** | `5432:5432` | `5432:5432` | 相同 |
| **健康检查** | 相同配置 | 相同配置 | 相同 |

#### 资源分配对比

**PostgreSQL容器资源：**

| 资源类型 | 开发环境 | 生产环境 | 差异倍数 |
|----------|----------|----------|----------|
| **内存限制** | 1G | 2G | 2x |
| **CPU限制** | 1.0 | 2.0 | 2x |
| **内存预留** | 512M | 1G | 2x |
| **CPU预留** | 0.5 | 1.0 | 2x |

**Redis容器资源：**

| 资源类型 | 开发环境 | 生产环境 | 差异倍数 |
|----------|----------|----------|----------|
| **内存限制** | 512M | 1G | 2x |
| **CPU限制** | 0.5 | 1.0 | 2x |
| **内存预留** | 256M | 512M | 2x |
| **CPU预留** | 0.25 | 0.5 | 2x |

**Flask应用容器资源：**

| 资源类型 | 开发环境 | 生产环境 | 差异倍数 |
|----------|----------|----------|----------|
| **内存限制** | 2G | 4G | 2x |
| **CPU限制** | 2.0 | 4.0 | 2x |
| **内存预留** | 1G | 2G | 2x |
| **CPU预留** | 1.0 | 2.0 | 2x |

### 2. Dockerfile配置

#### 构建参数对比

| 参数 | 开发环境 | 生产环境 | 说明 |
|------|----------|----------|------|
| **代理支持** | 无 | 有 | 生产环境支持企业代理 |
| **构建目标** | `development` | `production` | 不同优化策略 |
| **依赖安装** | 包含开发依赖 | 仅生产依赖 | 减少镜像大小 |

#### 代理配置差异

**开发环境：**
```dockerfile
# 无代理配置
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
```

**生产环境：**
```dockerfile
# 支持代理配置
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

ENV HTTP_PROXY=${HTTP_PROXY}
ENV HTTPS_PROXY=${HTTPS_PROXY}
ENV NO_PROXY=${NO_PROXY}

RUN if [ -n "$HTTP_PROXY" ]; then \
        curl -LsSf --proxy "$HTTP_PROXY" https://astral.sh/uv/install.sh | sh; \
    else \
        curl -LsSf https://astral.sh/uv/install.sh | sh; \
    fi
```

## 🌐 Nginx配置对比

### 1. 站点配置差异

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **静态文件缓存** | `expires 1h` | `expires 1y` | 生产环境长期缓存 |
| **Cache-Control** | `"public"` | `"public, immutable"` | 生产环境更严格 |
| **端口监听** | `80` | `80, 443` | 生产环境支持HTTPS |
| **日志格式** | 默认 | 默认 | 已修复相同 |

### 2. 静态文件服务

**开发环境：**
```nginx
location /static/ {
    alias /app/app/static/;
    expires 1h;                    # 1小时缓存
    add_header Cache-Control "public";
    try_files $uri =404;
}
```

**生产环境：**
```nginx
location /static/ {
    alias /app/app/static/;
    expires 1y;                    # 1年缓存
    add_header Cache-Control "public, immutable";  # 不可变缓存
    try_files $uri =404;
}
```

## ⚙️ Gunicorn配置对比

### 1. 工作进程配置

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **工作进程数** | 2 | 2 | 相同 |
| **工作器类型** | gevent | gevent | 相同 |
| **连接数** | 1000 | 1000 | 相同 |
| **超时时间** | 30s | 30s | 相同 |

### 2. 日志配置

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **日志级别** | debug | info | 生产环境减少日志量 |
| **访问日志** | 启用 | 启用 | 相同 |
| **错误日志** | 启用 | 启用 | 相同 |

**开发环境：**
```python
loglevel = "debug"  # 详细日志
```

**生产环境：**
```python
loglevel = "info"   # 减少日志量
```

## 🔧 环境变量对比

### 1. 应用配置

| 变量名 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **FLASK_ENV** | `development` | `production` | 环境标识 |
| **FLASK_DEBUG** | `1` | `0` | 生产环境关闭调试 |
| **LOG_LEVEL** | `DEBUG` | `INFO` | 生产环境减少日志 |
| **APP_VERSION** | `1.0.0-dev` | `1.0.0` | 版本标识 |

### 2. 数据库配置

| 变量名 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **POSTGRES_DB** | `whalefall_dev` | `whalefall_prod` | 数据库名隔离 |
| **DATABASE_URL** | `DATABASE_URL_DOCKER` | `DATABASE_URL_PROD` | 不同连接字符串 |

### 3. 代理配置

| 变量名 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **HTTP_PROXY** | 未设置 | 可设置 | 生产环境支持代理 |
| **HTTPS_PROXY** | 未设置 | 可设置 | 生产环境支持代理 |
| **NO_PROXY** | 未设置 | 可设置 | 生产环境支持代理 |

## 🔄 进程管理对比

### Supervisor配置

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **用户** | root | root | 相同 |
| **自动启动** | true | true | 相同 |
| **自动重启** | true | true | 相同 |
| **日志配置** | 相同 | 相同 | 相同 |

### 启动脚本

| 脚本 | 开发环境 | 生产环境 | 说明 |
|------|----------|----------|------|
| **启动脚本** | `start-dev-services.sh` | `start-prod-services.sh` | 相同内容 |
| **Supervisor配置** | `whalefall-dev.conf` | `whalefall-prod.conf` | 相同配置 |

## 📊 性能对比

### 1. 资源使用

| 资源类型 | 开发环境 | 生产环境 | 差异 |
|----------|----------|----------|------|
| **总内存** | 3.5G | 7G | 2x |
| **总CPU** | 3.5核 | 7核 | 2x |
| **磁盘I/O** | 标准 | 优化 | 生产环境优化 |

### 2. 性能优化

| 优化项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **静态文件缓存** | 1小时 | 1年 | 生产环境长期缓存 |
| **数据库连接池** | 标准 | 优化 | 生产环境更高性能 |
| **日志级别** | DEBUG | INFO | 生产环境减少I/O |
| **错误处理** | 基础 | 完整 | 生产环境更完善 |

## 🚀 部署命令对比

### 1. Makefile命令

| 命令 | 开发环境 | 生产环境 | 说明 |
|------|----------|----------|------|
| **启动** | `make dev start` | `make prod start` | 不同环境 |
| **停止** | `make dev stop` | `make prod stop` | 不同环境 |
| **状态** | `make dev status` | `make prod status` | 不同环境 |
| **日志** | `make dev logs` | `make prod logs` | 不同环境 |

### 2. Docker Compose命令

| 命令 | 开发环境 | 生产环境 | 说明 |
|------|----------|----------|------|
| **配置文件** | `docker-compose.dev.yml` | `docker-compose.prod.yml` | 不同配置 |
| **镜像标签** | `whalefall:dev` | `whalefall:prod` | 不同标签 |
| **网络名称** | `whalefall_dev_network` | `whalefall_prod_network` | 不同网络 |

## 🔒 安全配置对比

### 1. 网络安全

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **端口暴露** | 80, 5001 | 80, 443, 5001 | 生产环境支持HTTPS |
| **防火墙** | 基础 | 严格 | 生产环境更严格 |
| **访问控制** | 宽松 | 严格 | 生产环境更严格 |

### 2. 应用安全

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **调试模式** | 启用 | 禁用 | 生产环境安全 |
| **错误信息** | 详细 | 简化 | 生产环境不泄露信息 |
| **日志敏感信息** | 可能包含 | 过滤 | 生产环境更安全 |

## 📈 监控和运维对比

### 1. 日志管理

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **日志级别** | DEBUG | INFO | 生产环境减少日志量 |
| **日志轮转** | 基础 | 优化 | 生产环境更完善 |
| **日志存储** | 本地 | 可配置 | 生产环境更灵活 |

### 2. 健康检查

| 配置项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **检查间隔** | 30s | 30s | 相同 |
| **超时时间** | 10s | 10s | 相同 |
| **重试次数** | 3 | 3 | 相同 |
| **启动等待** | 60s | 60s | 相同 |

## 🛠️ 故障排除对比

### 1. 调试工具

| 工具 | 开发环境 | 生产环境 | 说明 |
|------|----------|----------|------|
| **调试模式** | 启用 | 禁用 | 开发环境便于调试 |
| **详细日志** | 启用 | 禁用 | 开发环境更多信息 |
| **错误堆栈** | 完整 | 简化 | 生产环境安全 |

### 2. 性能监控

| 监控项 | 开发环境 | 生产环境 | 说明 |
|--------|----------|----------|------|
| **资源监控** | 基础 | 完整 | 生产环境更完善 |
| **性能指标** | 基础 | 详细 | 生产环境更详细 |
| **告警机制** | 无 | 有 | 生产环境有告警 |

## 📚 最佳实践建议

### 1. 开发环境

- 使用调试模式进行开发
- 启用详细日志便于调试
- 使用较小的资源分配
- 快速启动和重启

### 2. 生产环境

- 禁用调试模式确保安全
- 使用INFO级别日志减少I/O
- 分配充足资源确保性能
- 实现完整的监控和告警

### 3. 环境切换

- 使用环境变量管理配置
- 保持配置文件同步
- 定期测试环境切换
- 文档化环境差异

---

**总结**: 开发环境和生产环境的主要差异在于资源分配、安全配置、性能优化和监控完善程度。开发环境注重开发效率和调试便利性，而生产环境注重性能、安全和稳定性。
