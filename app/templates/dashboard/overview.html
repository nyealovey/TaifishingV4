{% extends "base.html" %}

{% block title %}系统仪表板 - 鲸落{% endblock %}

{% block extra_css %}
<style>
/* 仪表盘标题样式 */
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.dashboard-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    position: relative;
    z-index: 2;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.dashboard-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0.5rem 0 0 0;
    position: relative;
    z-index: 2;
    font-weight: 300;
}

.dashboard-icon {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.2);
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
    animation: pulse 2s infinite;
}

.dashboard-icon i {
    font-size: 1.8rem;
    color: white;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.dashboard-actions {
    position: relative;
    z-index: 2;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.dashboard-action-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.dashboard-action-btn:hover {
    background: rgba(255,255,255,0.3);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.dashboard-stats {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    position: relative;
    z-index: 2;
    flex-wrap: wrap;
}

.dashboard-stat {
    text-align: center;
}

.dashboard-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

.dashboard-stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
    margin: 0.25rem 0 0 0;
    font-weight: 300;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .dashboard-header {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .dashboard-title {
        font-size: 2rem;
        flex-direction: column;
        text-align: center;
        gap: 0.5rem;
    }
    
    .dashboard-actions {
        justify-content: center;
        margin-top: 1rem;
    }
    
    .dashboard-stats {
        justify-content: center;
        gap: 1rem;
    }
}

/* 原有样式保持 */
.stat-card {
    transition: transform 0.2s;
}
.stat-card:hover {
    transform: translateY(-2px);
}
.chart-container {
    position: relative;
    height: 300px;
}
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.status-healthy {
    background-color: #28a745;
}
.status-error {
    background-color: #dc3545;
}
.status-warning {
    background-color: #ffc107;
}
</style>
{% endblock %}

{% block content %}
<!-- 美观的仪表盘标题区域 -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap">
        <div class="d-flex align-items-center">
            <div class="dashboard-icon">
                <i class="fas fa-tachometer-alt"></i>
            </div>
            <div>
                <h1 class="dashboard-title">系统仪表板</h1>
                <p class="dashboard-subtitle">实时监控系统状态与数据概览</p>
            </div>
        </div>
        <div class="dashboard-actions">
            <button type="button" class="dashboard-action-btn" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt me-2"></i>刷新数据
            </button>
            <button type="button" class="dashboard-action-btn" onclick="toggleAutoRefresh()">
                <i class="fas fa-clock me-2"></i>自动刷新
            </button>
        </div>
    </div>
    
    <!-- 快速统计信息 -->
    <div class="dashboard-stats">
        <div class="dashboard-stat">
            <div class="dashboard-stat-value">{{ overview.instances.total if overview and overview.instances else 0 }}</div>
            <div class="dashboard-stat-label">数据库实例</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-value">{{ overview.accounts.total if overview and overview.accounts else 0 }}</div>
            <div class="dashboard-stat-label">账户总数</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-value">{{ overview.classified_accounts.total if overview and overview.classified_accounts else 0 }}</div>
            <div class="dashboard-stat-label">已分类账户</div>
        </div>
        <div class="dashboard-stat">
            <div class="dashboard-stat-value">{{ overview.tasks.total if overview and overview.tasks else 0 }}</div>
            <div class="dashboard-stat-label">定时任务</div>
        </div>
    </div>
</div>

<!-- 系统概览卡片 -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card stat-card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ overview.instances.total if overview and overview.instances else 0 }}</h4>
                        <p class="card-text">数据库实例</p>
                        <small>{{ overview.instances.active if overview and overview.instances else 0 }} 活跃</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ overview.accounts.total if overview and overview.accounts else 0 }}</h4>
                        <p class="card-text">账户总数</p>
                        <small>{{ overview.accounts.active if overview and overview.accounts else 0 }} 活跃</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card h-100" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
            <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between mb-3">
                    <div>
                        <h4 class="card-title text-dark">{{ overview.classified_accounts.total if overview and overview.classified_accounts else 0 }}</h4>
                        <p class="card-text text-dark">分类账户</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tags fa-2x text-muted"></i>
                    </div>
                </div>
                
                <!-- 分类图标 - 所有分类显示在同一行 -->
                <div class="classification-list d-flex justify-content-between align-items-center">
                    {% if overview and overview.classified_accounts and overview.classified_accounts.classifications %}
                        {% for classification in overview.classified_accounts.classifications %}
                        <div class="d-flex align-items-center">
                            <div class="me-1">
                                {% if classification.name == '特权账户' %}
                                    <i class="fas fa-crown" style="color: {{ classification.color or '#ffc107' }};" title="特权账户"></i>
                                {% elif classification.name == '风险账户' %}
                                    <i class="fas fa-exclamation-triangle" style="color: {{ classification.color or '#dc3545' }};" title="风险账户"></i>
                                {% elif classification.name == '敏感账户' %}
                                    <i class="fas fa-shield-alt" style="color: {{ classification.color or '#007bff' }};" title="敏感账户"></i>
                                {% elif classification.name == '只读用户' %}
                                    <i class="fas fa-eye" style="color: {{ classification.color or '#28a745' }};" title="只读用户"></i>
                                {% elif classification.name == '普通账户' %}
                                    <i class="fas fa-user" style="color: {{ classification.color or '#3c49fb' }};" title="普通账户"></i>
                                {% else %}
                                    <i class="fas fa-tag" style="color: {{ classification.color or '#6c757d' }};" title="{{ classification.name }}"></i>
                                {% endif %}
                            </div>
                            <div>
                                <span class="text-dark small">{{ classification.count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center">
                            <small class="text-muted">暂无分类数据</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ overview.tasks.total if overview and overview.tasks else 0 }}</h4>
                        <p class="card-text">定时任务</p>
                        <small>{{ overview.tasks.active if overview and overview.tasks else 0 }} 活跃</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card stat-card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ overview.logs.today if overview and overview.logs else 0 }}</h4>
                        <p class="card-text">今日日志</p>
                        <small>{{ overview.logs.errors if overview and overview.logs else 0 }} 错误</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 图表区域 -->
    <div class="col-lg-8">
        <!-- 日志趋势图 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>错误和告警日志趋势（最近7天）
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="logTrendChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- 侧边栏 -->
    <div class="col-lg-4">
        <!-- 系统状态 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>系统状态
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>CPU使用率</span>
                        {% set cpu_badge_class = 'danger' if status and status.system and status.system.cpu > 80 else 'warning' if status and status.system and status.system.cpu > 60 else 'success' %}
                        <span class="badge bg-{{ cpu_badge_class }}">
                            {{ "%.1f"|format(status.system.cpu) if status and status.system else 0 }}%
                        </span>
                    </div>
                    <div class="progress">
                        {% set cpu_percent = status.system.cpu if status and status.system else 0 %}
                        {% set cpu_class = 'danger' if cpu_percent > 80 else 'warning' if cpu_percent > 60 else 'success' %}
                        <div class="progress-bar bg-{{ cpu_class }}" 
                             style="width: {{ cpu_percent }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>内存使用率</span>
                        {% set memory_badge_class = 'danger' if status and status.system and status.system.memory and status.system.memory.percent > 80 else 'warning' if status and status.system and status.system.memory and status.system.memory.percent > 60 else 'success' %}
                        <span class="badge bg-{{ memory_badge_class }}">
                            {{ "%.1f"|format(status.system.memory.percent) if status and status.system and status.system.memory else 0 }}%
                        </span>
                    </div>
                    <div class="progress">
                        {% set memory_percent = status.system.memory.percent if status and status.system and status.system.memory else 0 %}
                        {% set memory_class = 'danger' if memory_percent > 80 else 'warning' if memory_percent > 60 else 'success' %}
                        <div class="progress-bar bg-{{ memory_class }}" 
                             style="width: {{ memory_percent }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>磁盘使用率</span>
                        {% set disk_badge_class = 'danger' if status and status.system and status.system.disk and status.system.disk.percent > 80 else 'warning' if status and status.system and status.system.disk and status.system.disk.percent > 60 else 'success' %}
                        <span class="badge bg-{{ disk_badge_class }}">
                            {{ "%.1f"|format(status.system.disk.percent) if status and status.system and status.system.disk else 0 }}%
                        </span>
                    </div>
                    <div class="progress">
                        {% set disk_percent = status.system.disk.percent if status and status.system and status.system.disk else 0 %}
                        {% set disk_class = 'danger' if disk_percent > 80 else 'warning' if disk_percent > 60 else 'success' %}
                        <div class="progress-bar bg-{{ disk_class }}" 
                             style="width: {{ disk_percent }}%"></div>
                    </div>
                </div>
                
                <hr>
                
                <div class="mb-2">
                    <span class="status-indicator status-{{ status.services.database if status and status.services else 'error' }}"></span>
                    <strong>数据库:</strong> 
                    <span class="text-{{ 'success' if status and status.services and status.services.database == 'healthy' else 'danger' }}">
                        {{ '正常' if status and status.services and status.services.database == 'healthy' else '异常' }}
                    </span>
                </div>
                
                <div class="mb-2">
                    <span class="status-indicator status-{{ status.services.redis if status and status.services else 'error' }}"></span>
                    <strong>Redis:</strong> 
                    <span class="text-{{ 'success' if status and status.services and status.services.redis == 'healthy' else 'danger' }}">
                        {{ '正常' if status and status.services and status.services.redis == 'healthy' else '异常' }}
                    </span>
                </div>
                
                <div class="mb-2">
                    <span class="status-indicator status-{{ status.services.application if status and status.services else 'error' }}"></span>
                    <strong>应用:</strong> 
                    <span class="text-{{ 'success' if status and status.services and status.services.application == 'running' else 'danger' }}">
                        {{ '运行中' if status and status.services and status.services.application == 'running' else '停止' }}
                    </span>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        系统运行时间: {{ status.uptime if status else '未知' }}
                    </small>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='vendor/chartjs/chart.min.js') }}"></script>
<script>
let autoRefreshInterval = null;
let logTrendChart = null;

// 页面加载完成后初始化图表
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    startAutoRefresh();
});

function initCharts() {
    // 初始化日志趋势图
    initLogTrendChart();
}

function initLogTrendChart() {
    const ctx = document.getElementById('logTrendChart').getContext('2d');
    
    // 获取日志趋势数据
    fetch('/dashboard/api/charts?type=logs')
    .then(response => response.json())
    .then(data => {
        const logTrend = data.log_trend || [];
        
        logTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: logTrend.map(item => item.date),
                datasets: [{
                    label: '错误日志',
                    data: logTrend.map(item => item.error_count),
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    tension: 0.1
                }, {
                    label: '告警日志',
                    data: logTrend.map(item => item.warning_count),
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('加载日志趋势数据失败:', error);
    });
}


function refreshDashboard() {
    // 刷新页面数据
    location.reload();
}

function toggleAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        document.querySelector('button[onclick="toggleAutoRefresh()"]').innerHTML = 
            '<i class="fas fa-clock me-2"></i>自动刷新';
    } else {
        startAutoRefresh();
        document.querySelector('button[onclick="toggleAutoRefresh()"]').innerHTML = 
            '<i class="fas fa-pause me-2"></i>停止刷新';
    }
}

function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        // 刷新系统状态
        fetch('/dashboard/api/status')
        .then(response => response.json())
        .then(data => {
            updateSystemStatus(data);
        })
        .catch(error => {
            console.error('刷新系统状态失败:', error);
        });
    }, 30000); // 30秒刷新一次
}


function updateSystemStatus(status) {
    // 更新CPU使用率
    const cpuElement = document.querySelector('.card-body .mb-3:first-child .badge');
    const cpuBar = document.querySelector('.card-body .mb-3:first-child .progress-bar');
    if (cpuElement && cpuBar) {
        cpuElement.textContent = `${status.system.cpu.toFixed(1)}%`;
        cpuElement.className = `badge bg-${status.system.cpu > 80 ? 'danger' : status.system.cpu > 60 ? 'warning' : 'success'}`;
        cpuBar.style.width = `${status.system.cpu}%`;
        cpuBar.className = `progress-bar bg-${status.system.cpu > 80 ? 'danger' : status.system.cpu > 60 ? 'warning' : 'success'}`;
    }
    
    // 更新内存使用率
    const memoryElement = document.querySelector('.card-body .mb-3:nth-child(2) .badge');
    const memoryBar = document.querySelector('.card-body .mb-3:nth-child(2) .progress-bar');
    if (memoryElement && memoryBar) {
        memoryElement.textContent = `${status.system.memory.percent.toFixed(1)}%`;
        memoryElement.className = `badge bg-${status.system.memory.percent > 80 ? 'danger' : status.system.memory.percent > 60 ? 'warning' : 'success'}`;
        memoryBar.style.width = `${status.system.memory.percent}%`;
        memoryBar.className = `progress-bar bg-${status.system.memory.percent > 80 ? 'danger' : status.system.memory.percent > 60 ? 'warning' : 'success'}`;
    }
    
    // 更新磁盘使用率
    const diskElement = document.querySelector('.card-body .mb-3:nth-child(3) .badge');
    const diskBar = document.querySelector('.card-body .mb-3:nth-child(3) .progress-bar');
    if (diskElement && diskBar) {
        diskElement.textContent = `${status.system.disk.percent.toFixed(1)}%`;
        diskElement.className = `badge bg-${status.system.disk.percent > 80 ? 'danger' : status.system.disk.percent > 60 ? 'warning' : 'success'}`;
        diskBar.style.width = `${status.system.disk.percent}%`;
        diskBar.className = `progress-bar bg-${status.system.disk.percent > 80 ? 'danger' : status.system.disk.percent > 60 ? 'warning' : 'success'}`;
    }
    
    // 更新系统运行时间
    const uptimeElement = document.querySelector('.card-body .mt-3 small');
    if (uptimeElement) {
        uptimeElement.innerHTML = `<i class="fas fa-clock me-1"></i>系统运行时间: ${status.uptime || '未知'}`;
    }
}

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}
