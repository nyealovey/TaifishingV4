{% extends "base.html" %}

{% block title %}API状态 - 泰摸鱼吧{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-plug me-2"></i>API状态</h2>
    <button type="button" class="btn btn-outline-primary" onclick="refreshStatus()">
        <i class="fas fa-sync-alt me-2"></i>刷新状态
    </button>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>API概览
                </h5>
            </div>
            <div class="card-body">
                <div id="apiOverview">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-heartbeat me-2"></i>健康检查
                </h5>
            </div>
            <div class="card-body">
                <div id="healthCheck">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="text-muted mt-2">检查中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>API端点列表
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>端点</th>
                                <th>方法</th>
                                <th>描述</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="apiEndpoints">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后获取状态
document.addEventListener('DOMContentLoaded', function() {
    loadApiStatus();
    loadHealthCheck();
    loadApiEndpoints();
});

function loadApiStatus() {
    fetch('/api/status')
    .then(response => response.json())
    .then(data => {
        document.getElementById('apiOverview').innerHTML = `
            <div class="row">
                <div class="col-6">
                    <div class="text-center">
                        <h4 class="text-success">${data.status}</h4>
                        <p class="text-muted">API状态</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center">
                        <h4 class="text-info">${data.version}</h4>
                        <p class="text-muted">版本</p>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>消息:</strong> ${data.message}</p>
                ${data.user ? `<p><strong>当前用户:</strong> ${data.user}</p>` : ''}
            </div>
        `;
    })
    .catch(error => {
        document.getElementById('apiOverview').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                无法加载API状态: ${error.message}
            </div>
        `;
    });
}

function loadHealthCheck() {
    fetch('/api/health')
    .then(response => response.json())
    .then(data => {
        document.getElementById('healthCheck').innerHTML = `
            <div class="row">
                <div class="col-4">
                    <div class="text-center">
                        <h4 class="text-${data.status === 'healthy' ? 'success' : 'danger'}">${data.status}</h4>
                        <p class="text-muted">整体状态</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="text-center">
                        <h4 class="text-${data.database === 'connected' ? 'success' : 'danger'}">${data.database}</h4>
                        <p class="text-muted">数据库</p>
                    </div>
                </div>
                <div class="col-4">
                    <div class="text-center">
                        <h4 class="text-${data.redis === 'connected' ? 'success' : 'danger'}">${data.redis}</h4>
                        <p class="text-muted">Redis</p>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>时间戳:</strong> ${data.timestamp}</p>
            </div>
        `;
    })
    .catch(error => {
        document.getElementById('healthCheck').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                无法进行健康检查: ${error.message}
            </div>
        `;
    });
}

function loadApiEndpoints() {
    const endpoints = [
        { path: '/api/status', method: 'GET', description: 'API状态检查', status: 'active' },
        { path: '/api/health', method: 'GET', description: '健康检查', status: 'active' },
        { path: '/api/instances', method: 'GET', description: '获取实例列表', status: 'active' },
        { path: '/api/credentials', method: 'GET', description: '获取凭据列表', status: 'active' },
        { path: '/api/tasks', method: 'GET', description: '获取任务列表', status: 'active' },
        { path: '/api/logs', method: 'GET', description: '获取日志列表', status: 'active' },
        { path: '/api/params', method: 'GET', description: '获取参数列表', status: 'active' },
        { path: '/dashboard/api/overview', method: 'GET', description: '获取仪表板概览', status: 'active' },
        { path: '/dashboard/api/charts', method: 'GET', description: '获取图表数据', status: 'active' },
        { path: '/accounts/api/statistics', method: 'GET', description: '获取账户统计', status: 'active' }
    ];
    
    const tbody = document.getElementById('apiEndpoints');
    tbody.innerHTML = endpoints.map(endpoint => `
        <tr>
            <td><code>${endpoint.path}</code></td>
            <td><span class="badge bg-primary">${endpoint.method}</span></td>
            <td>${endpoint.description}</td>
            <td><span class="badge bg-success">${endpoint.status}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('${endpoint.path}', '${endpoint.method}')">
                    <i class="fas fa-play me-1"></i>测试
                </button>
            </td>
        </tr>
    `).join('');
}

function testEndpoint(path, method) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>测试中...';
    button.disabled = true;
    
    fetch(path, { method: method })
    .then(response => response.json())
    .then(data => {
        showAlert('success', `端点 ${path} 测试成功`);
    })
    .catch(error => {
        showAlert('danger', `端点 ${path} 测试失败: ${error.message}`);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshStatus() {
    loadApiStatus();
    loadHealthCheck();
    showAlert('info', '状态已刷新');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
