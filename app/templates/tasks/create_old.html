{% extends "base.html" %}

{% block title %}添加任务 - 泰摸鱼吧{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus me-2"></i>添加定时任务
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="taskForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">任务名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       placeholder="请输入任务名称" required>
                                <div class="form-text">用于标识此任务的唯一名称</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="task_type" class="form-label">任务类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="task_type" name="task_type" required>
                                    <option value="">请选择任务类型</option>
                                    <option value="sync_accounts">账户同步</option>
                                    <option value="sync_size">数据库大小同步</option>
                                    <option value="custom">自定义</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="db_type" class="form-label">数据库类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="db_type" name="db_type" required>
                                    <option value="">请选择数据库类型</option>
                                    <option value="postgresql">PostgreSQL</option>
                                    <option value="mysql">MySQL</option>
                                    <option value="sqlserver">SQL Server</option>
                                    <option value="oracle">Oracle</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="schedule" class="form-label">调度表达式</label>
                                <input type="text" class="form-control" id="schedule" name="schedule" 
                                       placeholder="例如: 0 0 * * *">
                                <div class="form-text">Cron表达式，如：0 0 * * * (每天午夜执行)，留空为手动执行</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="请输入任务描述（可选）"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="python_code" class="form-label">执行代码</label>
                        <textarea class="form-control" id="python_code" name="python_code" rows="8" 
                                  placeholder="系统将根据任务类型和数据库类型自动生成执行代码" readonly></textarea>
                        <div class="form-text">
                            系统将根据选择的任务类型和数据库类型自动生成对应的执行代码
                        </div>
                    </div>
                    
                    <input type="hidden" id="python_code_hidden" name="python_code_hidden" value="">
                    
                    <div class="mb-3">
                        <label for="config" class="form-label">任务配置 (JSON格式)</label>
                        <textarea class="form-control" id="config" name="config" rows="3" 
                                  placeholder='{"enabled": true, "timeout": 300}'></textarea>
                        <div class="form-text">JSON格式的配置参数，可选</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">
                            启用此任务
                        </label>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_builtin" name="is_builtin">
                        <label class="form-check-label" for="is_builtin">
                            标记为内置任务
                        </label>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('tasks.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回列表
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>创建任务
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 内置任务模板 - 使用统一服务
const BUILTIN_TASKS = {
    'sync_accounts': {
        'postgresql': `# 账户同步任务 - PostgreSQL
# 此任务将使用统一的AccountSyncService进行账户同步
# 无需手动编写代码，系统会自动调用相应的服务

def sync_postgresql_accounts(instance, config):
    """同步PostgreSQL数据库账户信息 - 使用统一服务"""
    from app.services.account_sync_service import account_sync_service
    
    # 调用统一的账户同步服务
    result = account_sync_service.sync_accounts(instance, sync_type='task')
    return result`,
        'mysql': `# 账户同步任务 - MySQL
# 此任务将使用统一的AccountSyncService进行账户同步
# 无需手动编写代码，系统会自动调用相应的服务

def sync_mysql_accounts(instance, config):
    """同步MySQL数据库账户信息 - 使用统一服务"""
    from app.services.account_sync_service import account_sync_service
    
    # 调用统一的账户同步服务
    result = account_sync_service.sync_accounts(instance, sync_type='task')
    return result`
    },
    'sync_version': {
        'postgresql': `def sync_postgresql_version(instance, config):
    """同步PostgreSQL数据库版本信息"""
    import psycopg2
    from app.models.instance import Instance
    from app import db
    from datetime import datetime
    
    try:
        # 连接数据库
        conn = psycopg2.connect(
            host=instance.host,
            port=instance.port,
            database=instance.database_name or 'postgres',
            user=instance.credential.username,
            password=instance.credential.get_plain_password()
        )
        
        cursor = conn.cursor()
        
        # 查询版本信息
        cursor.execute("SELECT version()")
        version_info = cursor.fetchone()[0]
        
        # 解析版本号
        version_parts = version_info.split()
        version = version_parts[1] if len(version_parts) > 1 else 'Unknown'
        
        # 更新实例信息
        instance.tags = instance.tags or {}
        instance.tags['version'] = version
        instance.tags['version_info'] = version_info
        instance.tags['last_version_sync'] = datetime.utcnow().isoformat()
        instance.updated_at = datetime.utcnow()
        
        db.session.commit()
        cursor.close()
        conn.close()
        
        return {
            'success': True,
            'message': f'成功同步PostgreSQL版本: {version}',
            'version': version
        }
        
    except Exception as e:
        return {
            'success': False,
            'error': f'PostgreSQL版本同步失败: {str(e)}'
        }`,
        'mysql': `def sync_mysql_version(instance, config):
    """同步MySQL数据库版本信息"""
    import pymysql
    from app.models.instance import Instance
    from app import db
    from datetime import datetime
    
    try:
        # 连接数据库
        conn = pymysql.connect(
            host=instance.host,
            port=instance.port,
            database=instance.database_name or 'mysql',
            user=instance.credential.username,
            password=instance.credential.get_plain_password()
        )
        
        cursor = conn.cursor()
        
        # 查询版本信息
        cursor.execute("SELECT VERSION()")
        version_info = cursor.fetchone()[0]
        
        # 解析版本号
        version_parts = version_info.split('-')
        version = version_parts[0] if version_parts else 'Unknown'
        
        # 更新实例信息
        instance.tags = instance.tags or {}
        instance.tags['version'] = version
        instance.tags['version_info'] = version_info
        instance.tags['last_version_sync'] = datetime.utcnow().isoformat()
        instance.updated_at = datetime.utcnow()
        
        db.session.commit()
        cursor.close()
        conn.close()
        
        return {
            'success': True,
            'message': f'成功同步MySQL版本: {version}',
            'version': version
        }
        
    except Exception as e:
        return {
            'success': False,
            'error': f'MySQL版本同步失败: {str(e)}'
        }`
    },
    'sync_size': {
        'postgresql': `def sync_postgresql_size(instance, config):
    """同步PostgreSQL数据库大小信息"""
    import psycopg2
    from app.models.instance import Instance
    from app import db
    from datetime import datetime
    
    try:
        # 连接数据库
        conn = psycopg2.connect(
            host=instance.host,
            port=instance.port,
            database=instance.database_name or 'postgres',
            user=instance.credential.username,
            password=instance.credential.get_plain_password()
        )
        
        cursor = conn.cursor()
        
        # 查询数据库大小
        cursor.execute("""
            SELECT 
                pg_database.datname,
                pg_size_pretty(pg_database_size(pg_database.datname)) as size_pretty,
                pg_database_size(pg_database.datname) as size_bytes
            FROM pg_database
            WHERE datname = current_database()
        """)
        
        size_info = cursor.fetchone()
        if size_info:
            db_name, size_pretty, size_bytes = size_info
            
            # 更新实例信息
            instance.tags = instance.tags or {}
            instance.tags['database_size'] = size_pretty
            instance.tags['database_size_bytes'] = size_bytes
            instance.tags['last_size_sync'] = datetime.utcnow().isoformat()
            instance.updated_at = datetime.utcnow()
            
            db.session.commit()
            
            return {
                'success': True,
                'message': f'成功同步PostgreSQL数据库大小: {size_pretty}',
                'size': size_pretty,
                'size_bytes': size_bytes
            }
        else:
            return {
                'success': False,
                'error': '无法获取数据库大小信息'
            }
        
        cursor.close()
        conn.close()
        
    except Exception as e:
        return {
            'success': False,
            'error': f'PostgreSQL数据库大小同步失败: {str(e)}'
        }`,
        'mysql': `def sync_mysql_size(instance, config):
    """同步MySQL数据库大小信息"""
    import pymysql
    from app.models.instance import Instance
    from app import db
    from datetime import datetime
    
    try:
        # 连接数据库
        conn = pymysql.connect(
            host=instance.host,
            port=instance.port,
            database=instance.database_name or 'mysql',
            user=instance.credential.username,
            password=instance.credential.get_plain_password()
        )
        
        cursor = conn.cursor()
        
        # 查询数据库大小
        cursor.execute("""
            SELECT 
                table_schema as database_name,
                ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) as size_mb,
                ROUND(SUM(data_length + index_length) / 1024 / 1024 / 1024, 2) as size_gb
            FROM information_schema.tables
            WHERE table_schema = DATABASE()
            GROUP BY table_schema
        """)
        
        size_info = cursor.fetchone()
        if size_info:
            db_name, size_mb, size_gb = size_info
            size_pretty = f"{size_gb} GB" if size_gb >= 1 else f"{size_mb} MB"
            
            # 更新实例信息
            instance.tags = instance.tags or {}
            instance.tags['database_size'] = size_pretty
            instance.tags['database_size_mb'] = size_mb
            instance.tags['database_size_gb'] = size_gb
            instance.tags['last_size_sync'] = datetime.utcnow().isoformat()
            instance.updated_at = datetime.utcnow()
            
            db.session.commit()
            
            return {
                'success': True,
                'message': f'成功同步MySQL数据库大小: {size_pretty}',
                'size': size_pretty,
                'size_mb': size_mb,
                'size_gb': size_gb
            }
        else:
            return {
                'success': False,
                'error': '无法获取数据库大小信息'
            }
        
        cursor.close()
        conn.close()
        
    except Exception as e:
        return {
            'success': False,
            'error': f'MySQL数据库大小同步失败: {str(e)}'
        }`
    }
};

// 自动生成代码
function generateCode() {
    const taskType = document.getElementById('task_type').value;
    const dbType = document.getElementById('db_type').value;
    const pythonCodeTextarea = document.getElementById('python_code');
    
    if (taskType && dbType && BUILTIN_TASKS[taskType] && BUILTIN_TASKS[taskType][dbType]) {
        pythonCodeTextarea.value = BUILTIN_TASKS[taskType][dbType];
    } else {
        pythonCodeTextarea.value = '# 请选择任务类型和数据库类型';
    }
}

// 监听任务类型和数据库类型变化
document.getElementById('task_type').addEventListener('change', generateCode);
document.getElementById('db_type').addEventListener('change', generateCode);

// 页面加载时生成代码
document.addEventListener('DOMContentLoaded', function() {
    generateCode();
});

// 表单提交处理
document.getElementById('taskForm').addEventListener('submit', function(e) {
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>创建中...';
    submitBtn.disabled = true;
    
    // 如果创建失败，恢复按钮状态
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 5000);
});
</script>
{% endblock %}
