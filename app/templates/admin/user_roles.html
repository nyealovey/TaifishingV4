{% extends "admin/admin_layout.html" %}

{% set title = "角色管理" %}
{% set subtitle = "用户角色和权限管理" %}
{% set show_refresh = true %}

{% block admin_content %}
<div class="row">
    <!-- 角色统计 -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="total-roles">0</h4>
                                <p class="card-text">总角色数</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-user-tag fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="active-roles">0</h4>
                                <p class="card-text">活跃角色</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="total-permissions">0</h4>
                                <p class="card-text">权限总数</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-key fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="users-with-roles">0</h4>
                                <p class="card-text">有角色用户</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色操作 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">角色操作</h5>
                <div>
                    <button class="btn btn-primary" onclick="showCreateRoleModal()">
                        <i class="fas fa-plus me-2"></i>创建角色
                    </button>
                    <button class="btn btn-success" onclick="showPermissionModal()">
                        <i class="fas fa-key me-2"></i>权限管理
                    </button>
                    <button class="btn btn-info" onclick="refreshRoles()">
                        <i class="fas fa-sync-alt me-2"></i>刷新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 角色列表 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">角色列表</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>角色名称</th>
                                <th>描述</th>
                                <th>权限数量</th>
                                <th>用户数量</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="roles-table-body">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑角色模态框 -->
<div class="modal fade" id="roleModal" tabindex="-1" aria-labelledby="roleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="roleModalLabel">创建角色</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="role-form">
                    <div class="mb-3">
                        <label for="role-name" class="form-label">角色名称 *</label>
                        <input type="text" class="form-control" id="role-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="role-description" class="form-label">角色描述</label>
                        <textarea class="form-control" id="role-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">权限设置</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-user-read">
                                    <label class="form-check-label" for="perm-user-read">
                                        用户查看
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-user-create">
                                    <label class="form-check-label" for="perm-user-create">
                                        用户创建
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-user-edit">
                                    <label class="form-check-label" for="perm-user-edit">
                                        用户编辑
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-user-delete">
                                    <label class="form-check-label" for="perm-user-delete">
                                        用户删除
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-admin">
                                    <label class="form-check-label" for="perm-admin">
                                        管理员权限
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-system">
                                    <label class="form-check-label" for="perm-system">
                                        系统管理
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-logs">
                                    <label class="form-check-label" for="perm-logs">
                                        日志查看
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="perm-config">
                                    <label class="form-check-label" for="perm-config">
                                        配置管理
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="role-active" checked>
                            <label class="form-check-label" for="role-active">
                                启用角色
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveRole()">保存角色</button>
            </div>
        </div>
    </div>
</div>

<!-- 权限管理模态框 -->
<div class="modal fade" id="permissionModal" tabindex="-1" aria-labelledby="permissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionModalLabel">权限管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>系统权限</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>用户管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('user')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('user')">删除</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>系统管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('system')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('system')">删除</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>日志管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('logs')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('logs')">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>业务权限</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>账户管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('account')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('account')">删除</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>任务管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('task')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('task')">删除</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>实例管理</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editPermission('instance')">编辑</button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deletePermission('instance')">删除</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addPermission()">添加权限</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentRoleId = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadRoleStats();
    loadRoles();
});

// 加载角色统计
async function loadRoleStats() {
    try {
        const response = await fetch('/admin/role-stats');
        const data = await response.json();
        
        if (data.success) {
            updateRoleStats(data.data);
        }
    } catch (error) {
        console.error('加载角色统计失败:', error);
    }
}

// 更新角色统计
function updateRoleStats(stats) {
    document.getElementById('total-roles').textContent = stats.total_roles || 0;
    document.getElementById('active-roles').textContent = stats.active_roles || 0;
    document.getElementById('total-permissions').textContent = stats.total_permissions || 0;
    document.getElementById('users-with-roles').textContent = stats.users_with_roles || 0;
}

// 加载角色列表
async function loadRoles() {
    try {
        const response = await fetch('/admin/roles');
        const data = await response.json();
        
        if (data.success) {
            updateRolesTable(data.data);
        }
    } catch (error) {
        console.error('加载角色列表失败:', error);
        showNotification('加载角色列表失败', 'error');
    }
}

// 更新角色表格
function updateRolesTable(roles) {
    const tbody = document.getElementById('roles-table-body');
    
    if (roles.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无角色数据</td></tr>';
        return;
    }
    
    let html = '';
    roles.forEach(role => {
        const statusClass = role.active ? 'bg-success' : 'bg-secondary';
        const statusText = role.active ? '启用' : '禁用';
        
        html += `
            <tr>
                <td>
                    <strong>${role.name}</strong>
                </td>
                <td>${role.description || '--'}</td>
                <td>
                    <span class="badge bg-info">${role.permission_count || 0}</span>
                </td>
                <td>
                    <span class="badge bg-primary">${role.user_count || 0}</span>
                </td>
                <td>
                    <span class="badge ${statusClass}">${statusText}</span>
                </td>
                <td>${new Date(role.created_at).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRole(${role.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewRolePermissions(${role.id})">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRole(${role.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// 显示创建角色模态框
function showCreateRoleModal() {
    currentRoleId = null;
    document.getElementById('roleModalLabel').textContent = '创建角色';
    document.getElementById('role-form').reset();
    document.getElementById('role-active').checked = true;
    new bootstrap.Modal(document.getElementById('roleModal')).show();
}

// 编辑角色
function editRole(roleId) {
    currentRoleId = roleId;
    document.getElementById('roleModalLabel').textContent = '编辑角色';
    // 这里应该加载角色数据到表单
    new bootstrap.Modal(document.getElementById('roleModal')).show();
}

// 保存角色
async function saveRole() {
    try {
        const form = document.getElementById('role-form');
        const formData = new FormData(form);
        
        const roleData = {
            name: document.getElementById('role-name').value,
            description: document.getElementById('role-description').value,
            active: document.getElementById('role-active').checked,
            permissions: []
        };
        
        // 收集权限
        const permissionCheckboxes = form.querySelectorAll('input[type="checkbox"]:not(#role-active)');
        permissionCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                roleData.permissions.push(checkbox.id.replace('perm-', ''));
            }
        });
        
        const url = currentRoleId ? `/admin/roles/${currentRoleId}` : '/admin/roles';
        const method = currentRoleId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            },
            body: JSON.stringify(roleData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('角色保存成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('roleModal')).hide();
            loadRoles();
            loadRoleStats();
        } else {
            showNotification('角色保存失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('保存角色失败:', error);
        showNotification('保存角色失败', 'error');
    }
}

// 删除角色
async function deleteRole(roleId) {
    if (!confirm('确定要删除这个角色吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/roles/${roleId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('角色删除成功', 'success');
            loadRoles();
            loadRoleStats();
        } else {
            showNotification('角色删除失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('删除角色失败:', error);
        showNotification('删除角色失败', 'error');
    }
}

// 查看角色权限
function viewRolePermissions(roleId) {
    showNotification('查看角色权限功能开发中...', 'info');
}

// 显示权限管理模态框
function showPermissionModal() {
    new bootstrap.Modal(document.getElementById('permissionModal')).show();
}

// 编辑权限
function editPermission(permissionId) {
    showNotification('编辑权限功能开发中...', 'info');
}

// 删除权限
function deletePermission(permissionId) {
    if (confirm('确定要删除这个权限吗？')) {
        showNotification('删除权限功能开发中...', 'info');
    }
}

// 添加权限
function addPermission() {
    showNotification('添加权限功能开发中...', 'info');
}

// 刷新角色
function refreshRoles() {
    loadRoles();
    loadRoleStats();
}

// 显示通知
function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
{% endblock %}
