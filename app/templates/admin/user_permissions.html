{% extends "admin/layout.html" %}

{% set title = "权限管理" %}
{% set subtitle = "系统权限和用户权限管理" %}
{% set show_refresh = true %}

{% block admin_content %}
<div class="row">
    <!-- 权限统计 -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="total-permissions">0</h4>
                                <p class="card-text">总权限数</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-key fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="system-permissions">0</h4>
                                <p class="card-text">系统权限</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-cogs fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="business-permissions">0</h4>
                                <p class="card-text">业务权限</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-briefcase fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4 class="card-title" id="active-permissions">0</h4>
                                <p class="card-text">活跃权限</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 权限操作 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">权限操作</h5>
                <div>
                    <button class="btn btn-primary" onclick="showCreatePermissionModal()">
                        <i class="fas fa-plus me-2"></i>创建权限
                    </button>
                    <button class="btn btn-success" onclick="showPermissionGroupsModal()">
                        <i class="fas fa-layer-group me-2"></i>权限分组
                    </button>
                    <button class="btn btn-info" onclick="refreshPermissions()">
                        <i class="fas fa-sync-alt me-2"></i>刷新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 权限分类标签 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="filterPermissions('all')">
                        全部权限
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterPermissions('system')">
                        系统权限
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterPermissions('business')">
                        业务权限
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterPermissions('active')">
                        活跃权限
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 权限列表 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">权限列表</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 20%;">权限名称</th>
                                <th style="width: 15%;">权限代码</th>
                                <th style="width: 10%;">权限类型</th>
                                <th style="width: 20%;">描述</th>
                                <th style="width: 10%;">关联角色</th>
                                <th style="width: 8%;">状态</th>
                                <th style="width: 12%;">创建时间</th>
                                <th style="width: 15%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="permissions-table-body">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑权限模态框 -->
<div class="modal fade" id="permissionModal" tabindex="-1" aria-labelledby="permissionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionModalLabel">创建权限</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="permission-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="permission-name" class="form-label">权限名称 *</label>
                                <input type="text" class="form-control" id="permission-name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="permission-code" class="form-label">权限代码 *</label>
                                <input type="text" class="form-control" id="permission-code" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="permission-type" class="form-label">权限类型 *</label>
                                <select class="form-select" id="permission-type" required>
                                    <option value="">请选择类型</option>
                                    <option value="system">系统权限</option>
                                    <option value="business">业务权限</option>
                                    <option value="api">API权限</option>
                                    <option value="ui">界面权限</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="permission-category" class="form-label">权限分类</label>
                                <select class="form-select" id="permission-category">
                                    <option value="">请选择分类</option>
                                    <option value="user">用户管理</option>
                                    <option value="system">系统管理</option>
                                    <option value="account">账户管理</option>
                                    <option value="task">任务管理</option>
                                    <option value="instance">实例管理</option>
                                    <option value="log">日志管理</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="permission-description" class="form-label">权限描述</label>
                        <textarea class="form-control" id="permission-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="permission-resource" class="form-label">资源路径</label>
                        <input type="text" class="form-control" id="permission-resource" placeholder="如: /admin/users">
                    </div>
                    <div class="mb-3">
                        <label for="permission-action" class="form-label">操作类型</label>
                        <select class="form-select" id="permission-action">
                            <option value="">请选择操作</option>
                            <option value="read">查看</option>
                            <option value="create">创建</option>
                            <option value="update">更新</option>
                            <option value="delete">删除</option>
                            <option value="execute">执行</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="permission-active" checked>
                            <label class="form-check-label" for="permission-active">
                                启用权限
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="savePermission()">保存权限</button>
            </div>
        </div>
    </div>
</div>

<!-- 权限分组模态框 -->
<div class="modal fade" id="permissionGroupsModal" tabindex="-1" aria-labelledby="permissionGroupsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="permissionGroupsModalLabel">权限分组管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>系统权限组</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>用户管理</strong>
                                        <br><small class="text-muted">用户相关的所有权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">8个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('user')">编辑</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>系统管理</strong>
                                        <br><small class="text-muted">系统配置和管理权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">12个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('system')">编辑</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>日志管理</strong>
                                        <br><small class="text-muted">日志查看和管理权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary">4个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('logs')">编辑</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>业务权限组</h6>
                        <div class="list-group">
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>账户管理</strong>
                                        <br><small class="text-muted">账户相关业务权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success">6个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('account')">编辑</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>任务管理</strong>
                                        <br><small class="text-muted">任务执行和管理权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success">5个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('task')">编辑</button>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>实例管理</strong>
                                        <br><small class="text-muted">实例操作和管理权限</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-success">7个权限</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editGroup('instance')">编辑</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="addPermissionGroup()">添加分组</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* 权限管理表格样式优化 */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-group-sm .btn i {
    font-size: 0.75rem;
}

/* 表格操作列优化 */
.table td:last-child {
    white-space: nowrap;
    vertical-align: middle;
}

/* 权限类型标签样式 */
.badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
}

/* 权限代码样式 */
code {
    font-size: 0.8rem;
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}
</style>
<script>
let currentPermissionId = null;
let currentFilter = 'all';

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPermissionStats();
    loadPermissions();
});

// 加载权限统计
async function loadPermissionStats() {
    try {
        const response = await fetch('/admin/permission-stats');
        const data = await response.json();
        
        if (data.success) {
            updatePermissionStats(data.data);
        }
    } catch (error) {
        console.error('加载权限统计失败:', error);
    }
}

// 更新权限统计
function updatePermissionStats(stats) {
    document.getElementById('total-permissions').textContent = stats.total_permissions || 0;
    document.getElementById('system-permissions').textContent = stats.system_permissions || 0;
    document.getElementById('business-permissions').textContent = stats.business_permissions || 0;
    document.getElementById('active-permissions').textContent = stats.active_permissions || 0;
}

// 加载权限列表
async function loadPermissions() {
    try {
        const response = await fetch('/admin/permissions');
        const data = await response.json();
        
        if (data.success) {
            updatePermissionsTable(data.data);
        }
    } catch (error) {
        console.error('加载权限列表失败:', error);
        showNotification('加载权限列表失败', 'error');
    }
}

// 更新权限表格
function updatePermissionsTable(permissions) {
    const tbody = document.getElementById('permissions-table-body');
    
    if (permissions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无权限数据</td></tr>';
        return;
    }
    
    let html = '';
    permissions.forEach(permission => {
        const statusClass = permission.active ? 'bg-success' : 'bg-secondary';
        const statusText = permission.active ? '启用' : '禁用';
        const typeClass = permission.type === 'system' ? 'bg-primary' : 'bg-success';
        
        html += `
            <tr>
                <td>
                    <strong>${permission.name}</strong>
                </td>
                <td>
                    <code>${permission.code}</code>
                </td>
                <td>
                    <span class="badge ${typeClass}">${permission.type_label || permission.type}</span>
                </td>
                <td>${permission.description || '--'}</td>
                <td>
                    <span class="badge bg-secondary">${permission.role_count || 0}个角色</span>
                </td>
                <td>
                    <span class="badge ${statusClass}">${statusText}</span>
                </td>
                <td>${new Date(permission.created_at).toLocaleString()}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editPermission(${permission.id})" title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewPermissionRoles(${permission.id})" title="查看角色">
                            <i class="fas fa-user-tag"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deletePermission(${permission.id})" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// 筛选权限
function filterPermissions(filter) {
    currentFilter = filter;
    
    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // 重新加载权限列表
    loadPermissions();
}

// 显示创建权限模态框
function showCreatePermissionModal() {
    currentPermissionId = null;
    document.getElementById('permissionModalLabel').textContent = '创建权限';
    document.getElementById('permission-form').reset();
    document.getElementById('permission-active').checked = true;
    new bootstrap.Modal(document.getElementById('permissionModal')).show();
}

// 编辑权限
function editPermission(permissionId) {
    currentPermissionId = permissionId;
    document.getElementById('permissionModalLabel').textContent = '编辑权限';
    // 这里应该加载权限数据到表单
    new bootstrap.Modal(document.getElementById('permissionModal')).show();
}

// 保存权限
async function savePermission() {
    try {
        const form = document.getElementById('permission-form');
        
        const permissionData = {
            name: document.getElementById('permission-name').value,
            code: document.getElementById('permission-code').value,
            type: document.getElementById('permission-type').value,
            category: document.getElementById('permission-category').value,
            description: document.getElementById('permission-description').value,
            resource: document.getElementById('permission-resource').value,
            action: document.getElementById('permission-action').value,
            active: document.getElementById('permission-active').checked
        };
        
        const url = currentPermissionId ? `/admin/permissions/${currentPermissionId}` : '/admin/permissions';
        const method = currentPermissionId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            },
            body: JSON.stringify(permissionData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('权限保存成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('permissionModal')).hide();
            loadPermissions();
            loadPermissionStats();
        } else {
            showNotification('权限保存失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('保存权限失败:', error);
        showNotification('保存权限失败', 'error');
    }
}

// 删除权限
async function deletePermission(permissionId) {
    if (!confirm('确定要删除这个权限吗？')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/permissions/${permissionId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('权限删除成功', 'success');
            loadPermissions();
            loadPermissionStats();
        } else {
            showNotification('权限删除失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('删除权限失败:', error);
        showNotification('删除权限失败', 'error');
    }
}

// 查看权限关联角色
function viewPermissionRoles(permissionId) {
    showNotification('查看权限关联角色功能开发中...', 'info');
}

// 显示权限分组模态框
function showPermissionGroupsModal() {
    new bootstrap.Modal(document.getElementById('permissionGroupsModal')).show();
}

// 编辑权限分组
function editGroup(groupId) {
    showNotification('编辑权限分组功能开发中...', 'info');
}

// 添加权限分组
function addPermissionGroup() {
    showNotification('添加权限分组功能开发中...', 'info');
}

// 刷新权限
function refreshPermissions() {
    loadPermissions();
    loadPermissionStats();
}

// 显示通知
function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
{% endblock %}
