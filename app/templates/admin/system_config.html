{% extends "base.html" %}

{% block title %}系统配置 - 泰摸鱼吧{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- 页面标题 -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">系统配置</h2>
                    <p class="text-muted mb-0">系统参数配置和管理</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i>刷新
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
    <!-- 配置分类导航 -->
    <div class="col-md-3 mb-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">配置分类</h6>
            </div>
            <div class="list-group list-group-flush">
                <a href="#basic-config" class="list-group-item list-group-item-action active" onclick="showConfigSection('basic-config')">
                    <i class="fas fa-cog me-2"></i>基础配置
                </a>
                <a href="#database-config" class="list-group-item list-group-item-action" onclick="showConfigSection('database-config')">
                    <i class="fas fa-database me-2"></i>数据库配置
                </a>
                <a href="#security-config" class="list-group-item list-group-item-action" onclick="showConfigSection('security-config')">
                    <i class="fas fa-shield-alt me-2"></i>安全配置
                </a>
                <a href="#email-config" class="list-group-item list-group-item-action" onclick="showConfigSection('email-config')">
                    <i class="fas fa-envelope me-2"></i>邮件配置
                </a>
                <a href="#logging-config" class="list-group-item list-group-item-action" onclick="showConfigSection('logging-config')">
                    <i class="fas fa-file-alt me-2"></i>日志配置
                </a>
                <a href="#performance-config" class="list-group-item list-group-item-action" onclick="showConfigSection('performance-config')">
                    <i class="fas fa-tachometer-alt me-2"></i>性能配置
                </a>
            </div>
        </div>
    </div>

    <!-- 配置内容区域 -->
    <div class="col-md-9">
        <!-- 基础配置 -->
        <div id="basic-config" class="config-section">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>基础配置</h5>
                </div>
                <div class="card-body">
                    <form id="basic-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="app_name" class="form-label">应用名称</label>
                                    <input type="text" class="form-control" id="app_name" value="泰摸鱼吧">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="app_version" class="form-label">应用版本</label>
                                    <input type="text" class="form-control" id="app_version" value="4.0.0" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="debug_mode" class="form-label">调试模式</label>
                                    <select class="form-select" id="debug_mode">
                                        <option value="true">启用</option>
                                        <option value="false" selected>禁用</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">时区</label>
                                    <select class="form-select" id="timezone">
                                        <option value="Asia/Shanghai" selected>Asia/Shanghai</option>
                                        <option value="UTC">UTC</option>
                                        <option value="America/New_York">America/New_York</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="secret_key" class="form-label">密钥</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="secret_key" value="****************">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleSecretKey()">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('basic')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 数据库配置 -->
        <div id="database-config" class="config-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>数据库配置</h5>
                </div>
                <div class="card-body">
                    <form id="database-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_type" class="form-label">数据库类型</label>
                                    <select class="form-select" id="db_type">
                                        <option value="sqlite" selected>SQLite</option>
                                        <option value="mysql">MySQL</option>
                                        <option value="postgresql">PostgreSQL</option>
                                        <option value="oracle">Oracle</option>
                                        <option value="sqlserver">SQL Server</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_host" class="form-label">数据库主机</label>
                                    <input type="text" class="form-control" id="db_host" value="localhost">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_port" class="form-label">端口</label>
                                    <input type="number" class="form-control" id="db_port" value="3306">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_name" class="form-label">数据库名</label>
                                    <input type="text" class="form-control" id="db_name" value="taifish_dev">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_username" class="form-label">用户名</label>
                                    <input type="text" class="form-control" id="db_username" value="root">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="db_password" class="form-label">密码</label>
                                    <input type="password" class="form-control" id="db_password" value="********">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="db_pool_size" class="form-label">连接池大小</label>
                            <input type="number" class="form-control" id="db_pool_size" value="10" min="1" max="100">
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('database')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                        <button type="button" class="btn btn-info ms-2" onclick="testConnection()">
                            <i class="fas fa-plug me-2"></i>测试连接
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 安全配置 -->
        <div id="security-config" class="config-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>安全配置</h5>
                </div>
                <div class="card-body">
                    <form id="security-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="session_timeout" class="form-label">会话超时(分钟)</label>
                                    <input type="number" class="form-control" id="session_timeout" value="30" min="5" max="1440">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_login_attempts" class="form-label">最大登录尝试次数</label>
                                    <input type="number" class="form-control" id="max_login_attempts" value="5" min="3" max="10">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="password_min_length" class="form-label">密码最小长度</label>
                                    <input type="number" class="form-control" id="password_min_length" value="8" min="6" max="32">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="require_strong_password" class="form-label">要求强密码</label>
                                    <select class="form-select" id="require_strong_password">
                                        <option value="true" selected>是</option>
                                        <option value="false">否</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_2fa" checked>
                                <label class="form-check-label" for="enable_2fa">
                                    启用双因素认证
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_csrf" checked>
                                <label class="form-check-label" for="enable_csrf">
                                    启用CSRF保护
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('security')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 邮件配置 -->
        <div id="email-config" class="config-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>邮件配置</h5>
                </div>
                <div class="card-body">
                    <form id="email-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtp_host" class="form-label">SMTP主机</label>
                                    <input type="text" class="form-control" id="smtp_host" value="smtp.gmail.com">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtp_port" class="form-label">SMTP端口</label>
                                    <input type="number" class="form-control" id="smtp_port" value="587">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtp_username" class="form-label">SMTP用户名</label>
                                    <input type="text" class="form-control" id="smtp_username" value="">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtp_password" class="form-label">SMTP密码</label>
                                    <input type="password" class="form-control" id="smtp_password" value="">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="smtp_use_tls" class="form-label">使用TLS</label>
                                    <select class="form-select" id="smtp_use_tls">
                                        <option value="true" selected>是</option>
                                        <option value="false">否</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="from_email" class="form-label">发件人邮箱</label>
                                    <input type="email" class="form-control" id="from_email" value="">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('email')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                        <button type="button" class="btn btn-info ms-2" onclick="testEmail()">
                            <i class="fas fa-paper-plane me-2"></i>测试邮件
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 日志配置 -->
        <div id="logging-config" class="config-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>日志配置</h5>
                </div>
                <div class="card-body">
                    <form id="logging-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="log_level" class="form-label">日志级别</label>
                                    <select class="form-select" id="log_level">
                                        <option value="DEBUG">DEBUG</option>
                                        <option value="INFO" selected>INFO</option>
                                        <option value="WARNING">WARNING</option>
                                        <option value="ERROR">ERROR</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="log_format" class="form-label">日志格式</label>
                                    <select class="form-select" id="log_format">
                                        <option value="simple" selected>简单格式</option>
                                        <option value="detailed">详细格式</option>
                                        <option value="json">JSON格式</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="log_file_size" class="form-label">日志文件大小(MB)</label>
                                    <input type="number" class="form-control" id="log_file_size" value="10" min="1" max="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="log_backup_count" class="form-label">备份文件数量</label>
                                    <input type="number" class="form-control" id="log_backup_count" value="5" min="1" max="20">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="log_to_file" checked>
                                <label class="form-check-label" for="log_to_file">
                                    输出到文件
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="log_to_console" checked>
                                <label class="form-check-label" for="log_to_console">
                                    输出到控制台
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('logging')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 性能配置 -->
        <div id="performance-config" class="config-section" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>性能配置</h5>
                </div>
                <div class="card-body">
                    <form id="performance-config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cache_ttl" class="form-label">缓存TTL(秒)</label>
                                    <input type="number" class="form-control" id="cache_ttl" value="3600" min="60" max="86400">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_workers" class="form-label">最大工作线程数</label>
                                    <input type="number" class="form-control" id="max_workers" value="4" min="1" max="16">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="request_timeout" class="form-label">请求超时(秒)</label>
                                    <input type="number" class="form-control" id="request_timeout" value="30" min="5" max="300">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_connections" class="form-label">最大连接数</label>
                                    <input type="number" class="form-control" id="max_connections" value="100" min="10" max="1000">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_compression" checked>
                                <label class="form-check-label" for="enable_compression">
                                    启用响应压缩
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_caching" checked>
                                <label class="form-check-label" for="enable_caching">
                                    启用缓存
                                </label>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveConfig('performance')">
                            <i class="fas fa-save me-2"></i>保存配置
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadConfigs();
});

// 显示配置分类
function showConfigSection(sectionId) {
    // 隐藏所有配置区域
    document.querySelectorAll('.config-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // 移除所有导航项的激活状态
    document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // 显示选中的配置区域
    document.getElementById(sectionId).style.display = 'block';
    
    // 激活对应的导航项
    event.target.classList.add('active');
}

// 加载所有配置
async function loadConfigs() {
    try {
        const response = await fetch('/admin/config');
        
        // 检查是否是重定向到登录页面
        if (response.redirected || response.url.includes('/auth/login')) {
            console.log('需要登录，重定向到登录页面');
            window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
            return;
        }
        
        // 检查响应状态
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            updateConfigForms(data.data);
        } else {
            showNotification('加载配置失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('加载配置失败:', error);
        showNotification('加载配置失败: ' + error.message, 'error');
    }
}

// 更新配置表单
function updateConfigForms(configs) {
    // 基础配置
    if (configs.basic) {
        document.getElementById('app_name').value = configs.basic.app_name || '';
        document.getElementById('app_version').value = configs.basic.app_version || '';
        document.getElementById('debug_mode').value = configs.basic.debug_mode ? 'true' : 'false';
        document.getElementById('timezone').value = configs.basic.timezone || 'Asia/Shanghai';
    }
    
    // 数据库配置
    if (configs.database) {
        document.getElementById('db_type').value = configs.database.db_type || 'sqlite';
        document.getElementById('db_host').value = configs.database.db_host || '';
        document.getElementById('db_port').value = configs.database.db_port || '';
        document.getElementById('db_name').value = configs.database.db_name || '';
        document.getElementById('db_username').value = configs.database.db_username || '';
        document.getElementById('db_pool_size').value = configs.database.db_pool_size || 10;
    }
    
    // 安全配置
    if (configs.security) {
        document.getElementById('session_timeout').value = configs.security.session_timeout || 30;
        document.getElementById('max_login_attempts').value = configs.security.max_login_attempts || 5;
        document.getElementById('password_min_length').value = configs.security.password_min_length || 8;
        document.getElementById('require_strong_password').value = configs.security.require_strong_password ? 'true' : 'false';
        document.getElementById('enable_2fa').checked = configs.security.enable_2fa || false;
        document.getElementById('enable_csrf').checked = configs.security.enable_csrf || false;
    }
    
    // 邮件配置
    if (configs.email) {
        document.getElementById('smtp_host').value = configs.email.smtp_host || '';
        document.getElementById('smtp_port').value = configs.email.smtp_port || 587;
        document.getElementById('smtp_username').value = configs.email.smtp_username || '';
        document.getElementById('smtp_use_tls').value = configs.email.smtp_use_tls ? 'true' : 'false';
        document.getElementById('from_email').value = configs.email.from_email || '';
    }
    
    // 日志配置
    if (configs.logging) {
        document.getElementById('log_level').value = configs.logging.log_level || 'INFO';
        document.getElementById('log_format').value = configs.logging.log_format || 'simple';
        document.getElementById('log_file_size').value = configs.logging.log_file_size || 10;
        document.getElementById('log_backup_count').value = configs.logging.log_backup_count || 5;
        document.getElementById('log_to_file').checked = configs.logging.log_to_file || false;
        document.getElementById('log_to_console').checked = configs.logging.log_to_console || false;
    }
    
    // 性能配置
    if (configs.performance) {
        document.getElementById('cache_ttl').value = configs.performance.cache_ttl || 3600;
        document.getElementById('max_workers').value = configs.performance.max_workers || 4;
        document.getElementById('request_timeout').value = configs.performance.request_timeout || 30;
        document.getElementById('max_connections').value = configs.performance.max_connections || 100;
        document.getElementById('enable_compression').checked = configs.performance.enable_compression || false;
        document.getElementById('enable_caching').checked = configs.performance.enable_caching || false;
    }
}

// 保存配置
async function saveConfig(configType) {
    try {
        const form = document.getElementById(configType + '-config-form');
        const formData = new FormData(form);
        const config = {};
        
        // 收集表单数据
        for (let [key, value] of formData.entries()) {
            config[key] = value;
        }
        
        // 处理复选框
        form.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            config[checkbox.id] = checkbox.checked;
        });
        
        const response = await fetch('/admin/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            },
            body: JSON.stringify({
                type: configType,
                config: config
            })
        });
        
        // 检查是否是重定向到登录页面
        if (response.redirected || response.url.includes('/auth/login')) {
            showNotification('会话已过期，请重新登录', 'error');
            setTimeout(() => {
                window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
            }, 2000);
            return;
        }
        
        // 检查响应状态
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('配置保存成功', 'success');
            
            // 如果是基础配置，刷新应用名称
            if (configType === 'basic') {
                // 刷新页面以更新右上角的应用名称
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else {
            showNotification('配置保存失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('保存配置失败:', error);
        showNotification('保存配置失败', 'error');
    }
}

// 测试数据库连接
async function testConnection() {
    try {
        const response = await fetch('/admin/config/test-db', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('数据库连接测试成功', 'success');
        } else {
            showNotification('数据库连接测试失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('测试数据库连接失败:', error);
        showNotification('测试数据库连接失败', 'error');
    }
}

// 测试邮件发送
async function testEmail() {
    try {
        const response = await fetch('/admin/config/test-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                             document.querySelector('input[name="csrf_token"]')?.value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('邮件发送测试成功', 'success');
        } else {
            showNotification('邮件发送测试失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('测试邮件发送失败:', error);
        showNotification('测试邮件发送失败', 'error');
    }
}

// 切换密钥显示
function toggleSecretKey() {
    const secretKeyInput = document.getElementById('secret_key');
    const toggleButton = event.target;
    
    if (secretKeyInput.type === 'password') {
        secretKeyInput.type = 'text';
        toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
    } else {
        secretKeyInput.type = 'password';
        toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
    }
}

// 显示通知
function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : 
                     type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
    </div>
</div>
{% endblock %}
