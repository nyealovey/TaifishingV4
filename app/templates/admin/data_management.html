{% extends "admin/admin_layout.html" %}

{% set title = "数据管理" %}
{% set subtitle = "数据备份、恢复和导出" %}
{% set show_refresh = true %}

{% block admin_content %}
<div class="row">
    <!-- 数据统计 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>数据统计
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="data-stats">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="total-records">--</h3>
                                <p class="card-text">总记录数</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="backup-count">--</h3>
                                <p class="card-text">备份数量</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="storage-used">--</h3>
                                <p class="card-text">存储使用</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="last-backup">--</h3>
                                <p class="card-text">最后备份</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速操作 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>快速操作
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-success w-100 mb-2" onclick="createBackup()">
                            <i class="fas fa-save me-2"></i>创建备份
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100 mb-2" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>导出数据
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning w-100 mb-2" onclick="optimizeDatabase()">
                            <i class="fas fa-tools me-2"></i>优化数据库
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info w-100 mb-2" onclick="checkIntegrity()">
                            <i class="fas fa-check-circle me-2"></i>检查完整性
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 备份管理 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-archive me-2"></i>备份管理
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="refreshBackups()">
                    <i class="fas fa-sync-alt me-1"></i>刷新
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>备份名称</th>
                                <th>大小</th>
                                <th>时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="backups-table">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据表管理 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>数据表管理
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>表名</th>
                                <th>记录数</th>
                                <th>大小</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tables-table">
                            <tr>
                                <td colspan="4" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入/导出 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exchange-alt me-2"></i>导入/导出
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>数据导出</h6>
                        <div class="mb-3">
                            <label class="form-label">导出格式</label>
                            <select class="form-select" id="export-format">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                                <option value="sql">SQL</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">导出范围</label>
                            <select class="form-select" id="export-scope">
                                <option value="all">全部数据</option>
                                <option value="users">用户数据</option>
                                <option value="logs">日志数据</option>
                                <option value="tasks">任务数据</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startExport()">
                            <i class="fas fa-download me-1"></i>开始导出
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>数据导入</h6>
                        <div class="mb-3">
                            <label class="form-label">选择文件</label>
                            <input type="file" class="form-control" id="import-file" accept=".json,.csv,.sql,.xlsx">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">导入模式</label>
                            <select class="form-select" id="import-mode">
                                <option value="append">追加</option>
                                <option value="replace">替换</option>
                                <option value="update">更新</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="startImport()">
                            <i class="fas fa-upload me-1"></i>开始导入
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 维护操作 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-wrench me-2"></i>维护操作
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-trash-alt fa-2x text-warning mb-2"></i>
                                <h6>清理旧数据</h6>
                                <p class="text-muted small">清理超过30天的日志和临时数据</p>
                                <button class="btn btn-warning btn-sm" onclick="cleanOldData()">
                                    开始清理
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-compress-alt fa-2x text-info mb-2"></i>
                                <h6>压缩数据库</h6>
                                <p class="text-muted small">压缩数据库文件以节省空间</p>
                                <button class="btn btn-info btn-sm" onclick="compressDatabase()">
                                    开始压缩
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                <h6>修复权限</h6>
                                <p class="text-muted small">修复文件权限和访问控制</p>
                                <button class="btn btn-success btn-sm" onclick="fixPermissions()">
                                    开始修复
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 进度模态框 -->
<div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">操作进度</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
                </div>
                <div id="progress-text">正在处理...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadDataStats();
    loadBackups();
    loadTables();
});

// 加载数据统计
async function loadDataStats() {
    try {
        const response = await fetch('/admin/data/stats');
        const data = await response.json();
        
        if (data.success) {
            updateDataStats(data.data);
        }
    } catch (error) {
        console.error('加载数据统计失败:', error);
    }
}

// 更新数据统计
function updateDataStats(stats) {
    document.getElementById('total-records').textContent = stats.total_records || 0;
    document.getElementById('backup-count').textContent = stats.backup_count || 0;
    document.getElementById('storage-used').textContent = (stats.storage_used || 0) + ' MB';
    document.getElementById('last-backup').textContent = stats.last_backup ? 
        new Date(stats.last_backup).toLocaleDateString() : '无';
}

// 加载备份列表
async function loadBackups() {
    try {
        const response = await fetch('/admin/data/backups');
        const data = await response.json();
        
        if (data.success) {
            updateBackupsTable(data.data);
        }
    } catch (error) {
        console.error('加载备份列表失败:', error);
    }
}

// 更新备份表格
function updateBackupsTable(backups) {
    const tbody = document.getElementById('backups-table');
    
    if (backups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无备份</td></tr>';
        return;
    }
    
    let html = '';
    backups.forEach(backup => {
        html += `
            <tr>
                <td>${backup.name}</td>
                <td>${formatFileSize(backup.size)}</td>
                <td>${new Date(backup.created_at).toLocaleString()}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="downloadBackup('${backup.name}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="restoreBackup('${backup.name}')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteBackup('${backup.name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// 加载数据表列表
async function loadTables() {
    try {
        const response = await fetch('/admin/data/tables');
        const data = await response.json();
        
        if (data.success) {
            updateTablesTable(data.data);
        }
    } catch (error) {
        console.error('加载数据表列表失败:', error);
    }
}

// 更新数据表表格
function updateTablesTable(tables) {
    const tbody = document.getElementById('tables-table');
    
    if (tables.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无数据表</td></tr>';
        return;
    }
    
    let html = '';
    tables.forEach(table => {
        html += `
            <tr>
                <td>${table.name}</td>
                <td>${table.record_count || 0}</td>
                <td>${formatFileSize(table.size || 0)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="analyzeTable('${table.name}')">
                            <i class="fas fa-chart-bar"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="optimizeTable('${table.name}')">
                            <i class="fas fa-tools"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 创建备份
async function createBackup() {
    if (confirm('确定要创建数据备份吗？')) {
        showProgress('正在创建备份...');
        
        try {
            const response = await fetch('/admin/data/backup', {
                method: 'POST'
            });
            const data = await response.json();
            
            hideProgress();
            
            if (data.success) {
                showNotification('备份创建成功', 'success');
                loadBackups();
                loadDataStats();
            } else {
                showNotification('备份创建失败: ' + data.message, 'error');
            }
        } catch (error) {
            hideProgress();
            console.error('创建备份失败:', error);
            showNotification('备份创建失败', 'error');
        }
    }
}

// 导出数据
function exportData() {
    const format = document.getElementById('export-format').value;
    const scope = document.getElementById('export-scope').value;
    
    showProgress('正在导出数据...');
    
    // 模拟导出过程
    setTimeout(() => {
        hideProgress();
        showNotification('数据导出功能开发中...', 'info');
    }, 2000);
}

// 优化数据库
function optimizeDatabase() {
    if (confirm('确定要优化数据库吗？这可能需要一些时间。')) {
        showProgress('正在优化数据库...');
        
        // 模拟优化过程
        setTimeout(() => {
            hideProgress();
            showNotification('数据库优化完成', 'success');
        }, 3000);
    }
}

// 检查完整性
function checkIntegrity() {
    showProgress('正在检查数据完整性...');
    
    // 模拟检查过程
    setTimeout(() => {
        hideProgress();
        showNotification('数据完整性检查完成', 'success');
    }, 2000);
}

// 刷新备份
function refreshBackups() {
    loadBackups();
    showNotification('备份列表已刷新', 'success');
}

// 下载备份
function downloadBackup(backupName) {
    showNotification('下载备份功能开发中...', 'info');
}

// 恢复备份
function restoreBackup(backupName) {
    if (confirm(`确定要恢复备份 "${backupName}" 吗？这将覆盖当前数据！`)) {
        showNotification('恢复备份功能开发中...', 'info');
    }
}

// 删除备份
function deleteBackup(backupName) {
    if (confirm(`确定要删除备份 "${backupName}" 吗？`)) {
        showNotification('删除备份功能开发中...', 'info');
    }
}

// 分析表
function analyzeTable(tableName) {
    showNotification(`分析表 "${tableName}" 功能开发中...`, 'info');
}

// 优化表
function optimizeTable(tableName) {
    if (confirm(`确定要优化表 "${tableName}" 吗？`)) {
        showNotification(`优化表 "${tableName}" 功能开发中...`, 'info');
    }
}

// 开始导出
function startExport() {
    exportData();
}

// 开始导入
function startImport() {
    const file = document.getElementById('import-file').files[0];
    if (!file) {
        showNotification('请选择要导入的文件', 'warning');
        return;
    }
    
    showNotification('数据导入功能开发中...', 'info');
}

// 清理旧数据
function cleanOldData() {
    if (confirm('确定要清理旧数据吗？这将删除超过30天的日志和临时数据。')) {
        showNotification('清理旧数据功能开发中...', 'info');
    }
}

// 压缩数据库
function compressDatabase() {
    if (confirm('确定要压缩数据库吗？这可能需要一些时间。')) {
        showNotification('压缩数据库功能开发中...', 'info');
    }
}

// 修复权限
function fixPermissions() {
    showNotification('修复权限功能开发中...', 'info');
}

// 显示进度
function showProgress(text) {
    document.getElementById('progress-text').textContent = text;
    document.getElementById('progress-bar').style.width = '0%';
    new bootstrap.Modal(document.getElementById('progressModal')).show();
}

// 隐藏进度
function hideProgress() {
    bootstrap.Modal.getInstance(document.getElementById('progressModal')).hide();
}
</script>
{% endblock %}
