{% extends "admin/admin_layout.html" %}

{% set title = "性能监控" %}
{% set subtitle = "系统性能指标和监控数据" %}
{% set show_refresh = true %}

{% block admin_content %}
<div class="row">
    <!-- 性能概览卡片 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>性能概览
                </h5>
            </div>
            <div class="card-body">
                <div class="row" id="performance-overview">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="cpu-usage">--</h3>
                                <p class="card-text">CPU使用率</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="memory-usage">--</h3>
                                <p class="card-text">内存使用率</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="disk-usage">--</h3>
                                <p class="card-text">磁盘使用率</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h3 class="card-title" id="response-time">--</h3>
                                <p class="card-text">平均响应时间</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 性能图表 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>性能趋势图
                </h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- 性能指标详情 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>详细指标
                </h5>
            </div>
            <div class="card-body">
                <div id="performance-details">
                    <div class="d-flex justify-content-between mb-2">
                        <span>活跃连接数:</span>
                        <span id="active-connections">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>请求总数:</span>
                        <span id="total-requests">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>错误率:</span>
                        <span id="error-rate">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>缓存命中率:</span>
                        <span id="cache-hit-rate">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>数据库连接数:</span>
                        <span id="db-connections">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 性能告警 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>性能告警
                </h5>
            </div>
            <div class="card-body">
                <div id="performance-alerts">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        正在加载性能告警信息...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="refreshPerformanceData()">
                        <i class="fas fa-sync-alt me-1"></i>刷新数据
                    </button>
                    <button class="btn btn-success" onclick="exportPerformanceData()">
                        <i class="fas fa-download me-1"></i>导出数据
                    </button>
                    <button class="btn btn-warning" onclick="clearPerformanceCache()">
                        <i class="fas fa-trash me-1"></i>清除缓存
                    </button>
                    <button class="btn btn-info" onclick="configureAlerts()">
                        <i class="fas fa-cog me-1"></i>配置告警
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let performanceChart = null;
let refreshInterval = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadPerformanceData();
    initPerformanceChart();
    startAutoRefresh();
});

// 加载性能数据
async function loadPerformanceData() {
    try {
        const response = await fetch('/admin/performance');
        const data = await response.json();
        
        if (data.success) {
            updatePerformanceOverview(data.data);
            updatePerformanceDetails(data.data);
            updatePerformanceAlerts(data.data.alerts || []);
        } else {
            showNotification('加载性能数据失败: ' + data.message, 'error');
        }
    } catch (error) {
        console.error('加载性能数据失败:', error);
        showNotification('加载性能数据失败', 'error');
    }
}

// 更新性能概览
function updatePerformanceOverview(data) {
    document.getElementById('cpu-usage').textContent = (data.cpu_percent || 0).toFixed(1) + '%';
    document.getElementById('memory-usage').textContent = (data.memory_percent || 0).toFixed(1) + '%';
    document.getElementById('disk-usage').textContent = (data.disk_percent || 0).toFixed(1) + '%';
    document.getElementById('response-time').textContent = (data.avg_response_time || 0).toFixed(2) + 'ms';
}

// 更新详细指标
function updatePerformanceDetails(data) {
    document.getElementById('active-connections').textContent = data.active_connections || 0;
    document.getElementById('total-requests').textContent = data.total_requests || 0;
    document.getElementById('error-rate').textContent = (data.error_rate || 0).toFixed(2) + '%';
    document.getElementById('cache-hit-rate').textContent = (data.cache_hit_rate || 0).toFixed(2) + '%';
    document.getElementById('db-connections').textContent = data.db_connections || 0;
}

// 更新性能告警
function updatePerformanceAlerts(alerts) {
    const alertsContainer = document.getElementById('performance-alerts');
    
    if (alerts.length === 0) {
        alertsContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>暂无性能告警</div>';
        return;
    }
    
    let alertsHtml = '';
    alerts.forEach(alert => {
        const alertClass = alert.level === 'error' ? 'alert-danger' : 
                          alert.level === 'warning' ? 'alert-warning' : 'alert-info';
        alertsHtml += `
            <div class="alert ${alertClass}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>${alert.metric}:</strong> ${alert.message}
                <small class="d-block text-muted">${new Date(alert.timestamp).toLocaleString()}</small>
            </div>
        `;
    });
    
    alertsContainer.innerHTML = alertsHtml;
}

// 初始化性能图表
function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'CPU使用率',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: '内存使用率',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// 开始自动刷新
function startAutoRefresh() {
    refreshInterval = setInterval(loadPerformanceData, 30000); // 30秒刷新一次
}

// 停止自动刷新
function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

// 刷新性能数据
function refreshPerformanceData() {
    loadPerformanceData();
    showNotification('性能数据已刷新', 'success');
}

// 导出性能数据
function exportPerformanceData() {
    showNotification('导出功能开发中...', 'info');
}

// 清除性能缓存
function clearPerformanceCache() {
    if (confirm('确定要清除性能缓存吗？')) {
        showNotification('缓存清除功能开发中...', 'info');
    }
}

// 配置告警
function configureAlerts() {
    showNotification('告警配置功能开发中...', 'info');
}

// 页面卸载时停止自动刷新
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
{% endblock %}
