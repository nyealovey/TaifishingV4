{% extends "base.html" %}

{% block title %}配置历史 - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.history-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.history-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.history-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.history-title {
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.history-meta {
    display: flex;
    gap: 15px;
    align-items: center;
    font-size: 14px;
    color: #6c757d;
}

.history-content {
    margin-bottom: 15px;
}

.history-changes {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
}

.change-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.change-item:last-child {
    border-bottom: none;
}

.change-key {
    font-weight: 600;
    color: #495057;
    min-width: 150px;
    margin-right: 15px;
}

.change-value {
    flex: 1;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.change-old {
    color: #dc3545;
    text-decoration: line-through;
}

.change-new {
    color: #28a745;
    font-weight: 600;
}

.history-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-sm {
    padding: 5px 12px;
    font-size: 12px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.status-danger {
    background: #f8d7da;
    color: #721c24;
}

.status-info {
    background: #d1ecf1;
    color: #0c5460;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.filter-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    display: block;
}

.pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 30px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    color: #dee2e6;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: #495057;
}

.empty-state p {
    margin-bottom: 0;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.loading i {
    font-size: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.diff-view {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
    margin-top: 10px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    max-height: 300px;
    overflow-y: auto;
}

.diff-line {
    padding: 2px 0;
    white-space: pre-wrap;
}

.diff-added {
    background: #d4edda;
    color: #155724;
}

.diff-removed {
    background: #f8d7da;
    color: #721c24;
}

.diff-context {
    background: #e9ecef;
    color: #495057;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-history"></i> 配置历史</h2>
                <div>
                    <a href="{{ url_for('config_management.index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> 返回配置管理
                    </a>
                    <button class="btn btn-outline-danger" onclick="clearHistory()">
                        <i class="fas fa-trash"></i> 清空历史
                    </button>
                </div>
            </div>

            <!-- 筛选区域 -->
            <div class="filter-section">
                <h5 class="mb-3"><i class="fas fa-filter"></i> 筛选条件</h5>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="searchInput">搜索关键词</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索配置名称或操作者...">
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">配置类型</label>
                        <select class="form-control" id="typeFilter">
                            <option value="">全部类型</option>
                            <option value="SYSTEM">系统配置</option>
                            <option value="DATABASE">数据库配置</option>
                            <option value="SECURITY">安全配置</option>
                            <option value="LOGGING">日志配置</option>
                            <option value="TASKS">任务配置</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">操作状态</label>
                        <select class="form-control" id="statusFilter">
                            <option value="">全部状态</option>
                            <option value="success">成功</option>
                            <option value="warning">警告</option>
                            <option value="error">错误</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="dateFilter">时间范围</label>
                        <select class="form-control" id="dateFilter">
                            <option value="">全部时间</option>
                            <option value="today">今天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search"></i> 筛选
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 历史记录列表 -->
            <div id="historyList">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载历史记录中...</p>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination-wrapper">
                <nav aria-label="配置历史分页">
                    <ul class="pagination" id="pagination">
                        <!-- 分页按钮将通过JavaScript生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 配置详情模态框 -->
<div class="modal fade" id="configDetailModal" tabindex="-1" aria-labelledby="configDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configDetailModalLabel">配置详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="configDetailContent">
                    <!-- 配置详情内容将通过JavaScript填充 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="restoreConfig()">恢复此配置</button>
            </div>
        </div>
    </div>
</div>

<!-- 清空历史确认模态框 -->
<div class="modal fade" id="clearHistoryModal" tabindex="-1" aria-labelledby="clearHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearHistoryModalLabel">确认清空历史</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要清空所有配置历史记录吗？此操作不可撤销。</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>警告：</strong>清空历史后，您将无法查看之前的配置修改记录，也无法恢复历史配置。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmClearHistory()">确认清空</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let pageSize = 10;
let totalPages = 0;
let currentFilters = {};

$(document).ready(function() {
    loadHistory();
    
    // 搜索框实时搜索
    $('#searchInput').on('input', function() {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
            applyFilters();
        }, 500);
    });
    
    // 筛选器变化时自动应用
    $('#typeFilter, #statusFilter, #dateFilter').on('change', function() {
        applyFilters();
    });
});

function loadHistory(page = 1) {
    currentPage = page;
    
    const params = {
        page: page,
        page_size: pageSize,
        ...currentFilters
    };
    
    $.ajax({
        url: '{{ url_for("config_management.get_history") }}',
        method: 'GET',
        data: params,
        beforeSend: function() {
            $('#historyList').html(`
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载历史记录中...</p>
                </div>
            `);
        },
        success: function(response) {
            if (response.success) {
                displayHistory(response.data.history);
                updatePagination(response.data.pagination);
            } else {
                showError('加载历史记录失败：' + response.message);
            }
        },
        error: function(xhr) {
            if (xhr.status === 401) {
                window.location.href = '/login';
                return;
            }
            showError('加载历史记录失败：' + (xhr.responseJSON?.message || '未知错误'));
        }
    });
}

function displayHistory(history) {
    if (!history || history.length === 0) {
        $('#historyList').html(`
            <div class="empty-state">
                <i class="fas fa-history"></i>
                <h3>暂无历史记录</h3>
                <p>还没有配置修改历史记录</p>
            </div>
        `);
        return;
    }
    
    let html = '';
    history.forEach(function(item) {
        const statusClass = getStatusClass(item.status);
        const statusText = getStatusText(item.status);
        const changesHtml = generateChangesHtml(item.changes);
        
        html += `
            <div class="history-item">
                <div class="history-header">
                    <h5 class="history-title">${item.title}</h5>
                    <div class="history-meta">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span><i class="fas fa-user"></i> ${item.operator}</span>
                        <span><i class="fas fa-clock"></i> ${formatDateTime(item.timestamp)}</span>
                    </div>
                </div>
                <div class="history-content">
                    <p><strong>配置类型：</strong>${getTypeText(item.config_type)}</p>
                    <p><strong>操作类型：</strong>${getOperationText(item.operation)}</p>
                    ${item.description ? `<p><strong>描述：</strong>${item.description}</p>` : ''}
                </div>
                ${changesHtml}
                <div class="history-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewConfigDetail(${item.id})">
                        <i class="fas fa-eye"></i> 查看详情
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="restoreConfig(${item.id})">
                        <i class="fas fa-undo"></i> 恢复配置
                    </button>
                </div>
            </div>
        `;
    });
    
    $('#historyList').html(html);
}

function generateChangesHtml(changes) {
    if (!changes || changes.length === 0) {
        return '';
    }
    
    let html = '<div class="history-changes"><h6>配置变更：</h6>';
    changes.forEach(function(change) {
        html += `
            <div class="change-item">
                <div class="change-key">${change.key}</div>
                <div class="change-value">
                    <span class="change-old">${change.old_value || '未设置'}</span>
                    <i class="fas fa-arrow-right mx-2"></i>
                    <span class="change-new">${change.new_value || '未设置'}</span>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    return html;
}

function viewConfigDetail(historyId) {
    $.ajax({
        url: `{{ url_for("config_management.get_history_detail") }}?id=${historyId}`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                displayConfigDetail(response.data);
                $('#configDetailModal').modal('show');
            } else {
                showError('获取配置详情失败：' + response.message);
            }
        },
        error: function(xhr) {
            showError('获取配置详情失败：' + (xhr.responseJSON?.message || '未知错误'));
        }
    });
}

function displayConfigDetail(data) {
    const changesHtml = generateChangesHtml(data.changes);
    const diffHtml = data.diff ? `<div class="diff-view">${data.diff}</div>` : '';
    
    $('#configDetailContent').html(`
        <div class="row">
            <div class="col-md-6">
                <h6>基本信息</h6>
                <p><strong>配置类型：</strong>${getTypeText(data.config_type)}</p>
                <p><strong>操作类型：</strong>${getOperationText(data.operation)}</p>
                <p><strong>操作者：</strong>${data.operator}</p>
                <p><strong>操作时间：</strong>${formatDateTime(data.timestamp)}</p>
                <p><strong>状态：</strong><span class="status-badge ${getStatusClass(data.status)}">${getStatusText(data.status)}</span></p>
            </div>
            <div class="col-md-6">
                <h6>详细信息</h6>
                <p><strong>描述：</strong>${data.description || '无'}</p>
                <p><strong>IP地址：</strong>${data.ip_address || '未知'}</p>
                <p><strong>用户代理：</strong>${data.user_agent || '未知'}</p>
            </div>
        </div>
        ${changesHtml}
        ${diffHtml}
    `);
}

function restoreConfig(historyId) {
    if (!confirm('确定要恢复此配置吗？当前配置将被覆盖。')) {
        return;
    }
    
    $.ajax({
        url: '{{ url_for("config_management.restore_config") }}',
        method: 'POST',
        data: {
            history_id: historyId,
            csrf_token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                showSuccess('配置恢复成功');
                loadHistory(currentPage);
                $('#configDetailModal').modal('hide');
            } else {
                showError('配置恢复失败：' + response.message);
            }
        },
        error: function(xhr) {
            showError('配置恢复失败：' + (xhr.responseJSON?.message || '未知错误'));
        }
    });
}

function clearHistory() {
    $('#clearHistoryModal').modal('show');
}

function confirmClearHistory() {
    $.ajax({
        url: '{{ url_for("config_management.clear_history") }}',
        method: 'POST',
        data: {
            csrf_token: '{{ csrf_token() }}'
        },
        success: function(response) {
            if (response.success) {
                showSuccess('历史记录已清空');
                loadHistory(1);
                $('#clearHistoryModal').modal('hide');
            } else {
                showError('清空历史失败：' + response.message);
            }
        },
        error: function(xhr) {
            showError('清空历史失败：' + (xhr.responseJSON?.message || '未知错误'));
        }
    });
}

function applyFilters() {
    currentFilters = {
        search: $('#searchInput').val(),
        config_type: $('#typeFilter').val(),
        status: $('#statusFilter').val(),
        date_range: $('#dateFilter').val()
    };
    
    loadHistory(1);
}

function resetFilters() {
    $('#searchInput').val('');
    $('#typeFilter').val('');
    $('#statusFilter').val('');
    $('#dateFilter').val('');
    currentFilters = {};
    loadHistory(1);
}

function updatePagination(pagination) {
    totalPages = pagination.total_pages;
    
    if (totalPages <= 1) {
        $('#pagination').html('');
        return;
    }
    
    let html = '';
    
    // 上一页
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${currentPage - 1})">上一页</a></li>`;
    }
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        html += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="loadHistory(${i})">${i}</a></li>`;
    }
    
    // 下一页
    if (currentPage < totalPages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadHistory(${currentPage + 1})">下一页</a></li>`;
    }
    
    $('#pagination').html(html);
}

// 工具函数
function getStatusClass(status) {
    const statusMap = {
        'success': 'status-success',
        'warning': 'status-warning',
        'error': 'status-danger',
        'info': 'status-info'
    };
    return statusMap[status] || 'status-info';
}

function getStatusText(status) {
    const statusMap = {
        'success': '成功',
        'warning': '警告',
        'error': '错误',
        'info': '信息'
    };
    return statusMap[status] || '未知';
}

function getTypeText(type) {
    const typeMap = {
        'SYSTEM': '系统配置',
        'DATABASE': '数据库配置',
        'SECURITY': '安全配置',
        'LOGGING': '日志配置',
        'TASKS': '任务配置'
    };
    return typeMap[type] || type;
}

function getOperationText(operation) {
    const operationMap = {
        'create': '创建',
        'update': '更新',
        'delete': '删除',
        'restore': '恢复',
        'batch_update': '批量更新',
        'batch_delete': '批量删除'
    };
    return operationMap[operation] || operation;
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}
</script>
{% endblock %}
