{% extends "base.html" %}

{% block title %}账户分类管理 - 泰摸鱼吧{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-tags me-2"></i>账户分类管理</h2>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createClassificationModal">
                <i class="fas fa-plus me-2"></i>新建分类
            </button>
            <button class="btn btn-success" onclick="autoClassifyAll()">
                <i class="fas fa-magic me-2"></i>自动分类
            </button>
            <a href="{{ url_for('account_classification.rules') }}" class="btn btn-info">
                <i class="fas fa-cogs me-2"></i>规则管理
            </a>
        </div>
    </div>

    <!-- 统计信息卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalClassifications">0</h4>
                            <p class="card-text">总分类数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalRules">0</h4>
                            <p class="card-text">总规则数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cogs fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalAssignments">0</h4>
                            <p class="card-text">已分配账户</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="highRiskAccounts">0</h4>
                            <p class="card-text">高风险账户</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="row">
        <!-- 左侧：分类列表 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>账户分类
                    </h5>
                </div>
                <div class="card-body">
                    <div id="classificationsList">
                        <!-- 分类列表将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：分类详情 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>分类详情
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-mouse-pointer fa-2x mb-2"></i>
                        <p>点击左侧分类查看详情</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 创建分类模态框 -->
<div class="modal fade" id="createClassificationModal" tabindex="-1" aria-labelledby="createClassificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createClassificationModalLabel">
                    <i class="fas fa-plus me-2"></i>新建账户分类
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="createClassificationForm">
                    <div class="mb-3">
                        <label for="classificationName" class="form-label">分类名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="classificationName" required>
                    </div>
                    <div class="mb-3">
                        <label for="classificationDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="classificationDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="riskLevel" class="form-label">风险等级</label>
                                <select class="form-select" id="riskLevel">
                                    <option value="low">低风险</option>
                                    <option value="medium" selected>中风险</option>
                                    <option value="high">高风险</option>
                                    <option value="critical">极高风险</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="classificationColor" class="form-label">显示颜色</label>
                                <input type="color" class="form-control form-control-color" id="classificationColor" value="#007bff">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label">优先级</label>
                        <input type="number" class="form-control" id="priority" value="0" min="0" max="100">
                        <div class="form-text">数字越大优先级越高</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createClassification()">创建</button>
            </div>
        </div>
    </div>
</div>

<!-- 创建规则模态框 -->
<div class="modal fade" id="createRuleModal" tabindex="-1" aria-labelledby="createRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRuleModalLabel">
                    <i class="fas fa-cogs me-2"></i>新建分类规则
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="createRuleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ruleClassification" class="form-label">分类 <span class="text-danger">*</span></label>
                                <select class="form-select" id="ruleClassification" required>
                                    <option value="">请选择分类</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ruleName" class="form-label">规则名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="ruleName" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="ruleDbType" class="form-label">数据库类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="ruleDbType" required onchange="loadPermissions()">
                            <option value="">请选择数据库类型</option>
                            <option value="mysql">MySQL</option>
                            <option value="postgresql">PostgreSQL</option>
                            <option value="sqlserver">SQL Server</option>
                            <option value="oracle">Oracle</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">权限配置</label>
                        <div id="permissionsConfig">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-info-circle me-2"></i>请先选择数据库类型
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createRule()">创建</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentClassificationId = null;
let currentDbType = null;

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadClassifications();
    loadStatistics();
});

// 加载分类列表
function loadClassifications() {
    fetch('/account-classification/classifications')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayClassifications(data.classifications);
            updateStatistics(data.classifications);
        } else {
            showAlert('danger', '加载分类失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '加载分类失败');
    });
}

// 显示分类列表
function displayClassifications(classifications) {
    const container = document.getElementById('classificationsList');
    
    if (classifications.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-info-circle me-2"></i>暂无分类</div>';
        return;
    }
    
    let html = '';
    classifications.forEach(classification => {
        const riskLevelClass = {
            'low': 'success',
            'medium': 'warning', 
            'high': 'danger',
            'critical': 'dark'
        }[classification.risk_level] || 'secondary';
        
        html += `
            <div class="card mb-2 classification-item" data-id="${classification.id}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${riskLevelClass} me-2" style="background-color: ${classification.color || '#6c757d'} !important;">
                                ${classification.name}
                            </span>
                            <small class="text-muted">${classification.rules_count} 规则</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editClassification(${classification.id})" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${!classification.is_system ? `
                                <button class="btn btn-outline-danger" onclick="deleteClassification(${classification.id})" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    ${classification.description ? `<small class="text-muted d-block mt-1">${classification.description}</small>` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 加载规则
function loadRules() {
    const dbType = document.getElementById('dbTypeSelect').value;
    if (!dbType) {
        document.getElementById('rulesList').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>请选择数据库类型查看规则</p>
            </div>
        `;
        return;
    }
    
    currentDbType = dbType;
    
    fetch(`/account-classification/rules?db_type=${dbType}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayRules(data.rules);
        } else {
            showAlert('danger', '加载规则失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '加载规则失败');
    });
}

// 显示规则列表
function displayRules(rules) {
    const container = document.getElementById('rulesList');
    
    if (rules.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle fa-2x mb-2"></i>
                <p>暂无规则</p>
                <button class="btn btn-primary btn-sm" onclick="showCreateRuleModal()">
                    <i class="fas fa-plus me-1"></i>创建规则
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    rules.forEach(rule => {
        html += `
            <div class="card mb-2 rule-item" data-id="${rule.id}">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${rule.rule_name}</h6>
                            <small class="text-muted">${rule.db_type.toUpperCase()}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editRule(${rule.id})" title="编辑">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteRule(${rule.id})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// 创建分类
function createClassification() {
    const form = document.getElementById('createClassificationForm');
    const formData = new FormData(form);
    
    const data = {
        name: document.getElementById('classificationName').value,
        description: document.getElementById('classificationDescription').value,
        risk_level: document.getElementById('riskLevel').value,
        color: document.getElementById('classificationColor').value,
        priority: parseInt(document.getElementById('priority').value)
    };
    
    fetch('/account-classification/classifications', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('createClassificationModal')).hide();
            form.reset();
            loadClassifications();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '创建分类失败');
    });
}

// 显示创建规则模态框
function showCreateRuleModal() {
    if (!currentDbType) {
        showAlert('warning', '请先选择数据库类型');
        return;
    }
    
    // 加载分类选项
    loadClassificationOptions();
    
    // 设置数据库类型
    document.getElementById('ruleDbType').value = currentDbType;
    document.getElementById('ruleDbType').disabled = true;
    
    // 加载权限配置
    loadPermissions();
    
    // 显示模态框
    new bootstrap.Modal(document.getElementById('createRuleModal')).show();
}

// 加载分类选项
function loadClassificationOptions() {
    fetch('/account-classification/classifications')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const select = document.getElementById('ruleClassification');
            select.innerHTML = '<option value="">请选择分类</option>';
            
            data.classifications.forEach(classification => {
                const option = document.createElement('option');
                option.value = classification.id;
                option.textContent = classification.name;
                select.appendChild(option);
            });
        }
    });
}

// 加载权限配置
function loadPermissions() {
    const dbType = document.getElementById('ruleDbType').value;
    if (!dbType) {
        document.getElementById('permissionsConfig').innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-info-circle me-2"></i>请先选择数据库类型
            </div>
        `;
        return;
    }
    
    fetch(`/account-classification/permissions/${dbType}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPermissionsConfig(data.permissions);
        } else {
            showAlert('danger', '加载权限配置失败: ' + data.error);
        }
    });
}

// 显示权限配置
function displayPermissionsConfig(permissions) {
    const container = document.getElementById('permissionsConfig');
    
    let html = '<div class="row">';
    
    // 根据数据库类型显示不同的权限配置
    if (permissions.global_privileges) {
        html += `
            <div class="col-md-6">
                <h6>全局权限</h6>
                <div class="permission-group">
                    ${permissions.global_privileges.map(perm => `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${perm.name}" id="perm_${perm.name}">
                            <label class="form-check-label" for="perm_${perm.name}">
                                ${perm.name}
                                <small class="text-muted d-block">${perm.description}</small>
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (permissions.database_privileges) {
        html += `
            <div class="col-md-6">
                <h6>数据库权限</h6>
                <div class="permission-group">
                    ${permissions.database_privileges.map(perm => `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="${perm}" id="db_perm_${perm}">
                            <label class="form-check-label" for="db_perm_${perm}">
                                ${perm}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    container.innerHTML = html;
}

// 创建规则
function createRule() {
    const classificationId = document.getElementById('ruleClassification').value;
    const ruleName = document.getElementById('ruleName').value;
    const dbType = document.getElementById('ruleDbType').value;
    
    if (!classificationId || !ruleName || !dbType) {
        showAlert('warning', '请填写所有必填字段');
        return;
    }
    
    // 收集选中的权限
    const selectedPermissions = [];
    const checkboxes = document.querySelectorAll('#permissionsConfig input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        selectedPermissions.push(checkbox.value);
    });
    
    if (selectedPermissions.length === 0) {
        showAlert('warning', '请至少选择一个权限');
        return;
    }
    
    const ruleExpression = {
        type: 'permissions',
        permissions: selectedPermissions,
        operator: 'OR' // 默认使用OR逻辑
    };
    
    const data = {
        classification_id: parseInt(classificationId),
        db_type: dbType,
        rule_name: ruleName,
        rule_expression: ruleExpression
    };
    
    fetch('/account-classification/rules', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('createRuleModal')).hide();
            document.getElementById('createRuleForm').reset();
            loadRules();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '创建规则失败');
    });
}

// 自动分类所有账户
function autoClassifyAll() {
    if (!confirm('确定要对所有账户进行自动分类吗？')) {
        return;
    }
    
    fetch('/account-classification/auto-classify', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            loadStatistics();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '自动分类失败');
    });
}

// 加载统计信息
function loadStatistics() {
    // 这里可以添加统计信息的加载逻辑
    // 暂时使用模拟数据
    document.getElementById('totalClassifications').textContent = '0';
    document.getElementById('totalRules').textContent = '0';
    document.getElementById('totalAssignments').textContent = '0';
    document.getElementById('highRiskAccounts').textContent = '0';
}

// 更新统计信息
function updateStatistics(classifications) {
    document.getElementById('totalClassifications').textContent = classifications.length;
    
    // 计算总规则数
    let totalRules = 0;
    classifications.forEach(classification => {
        totalRules += classification.rules_count || 0;
    });
    document.getElementById('totalRules').textContent = totalRules;
}

// 显示提示信息
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 插入到页面顶部
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3秒后自动消失
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 编辑分类
function editClassification(id) {
    // 实现编辑分类功能
    console.log('编辑分类:', id);
}

// 删除分类
function deleteClassification(id) {
    if (!confirm('确定要删除这个分类吗？')) {
        return;
    }
    
    fetch(`/account-classification/classifications/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            loadClassifications();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '删除分类失败');
    });
}

// 编辑规则
function editRule(id) {
    // 实现编辑规则功能
    console.log('编辑规则:', id);
}

// 删除规则
function deleteRule(id) {
    if (!confirm('确定要删除这个规则吗？')) {
        return;
    }
    
    fetch(`/account-classification/rules/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            loadRules();
        } else {
            showAlert('danger', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '删除规则失败');
    });
}

</script>
{% endblock %}
