{% extends "base.html" %}

{% block title %}自动分类记录 - 泰摸鱼吧{% endblock %}

{% block extra_css %}
<style>
    .batch-card {
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    .batch-card.running {
        border-left-color: #28a745;
    }
    .batch-card.completed {
        border-left-color: #17a2b8;
    }
    .batch-card.failed {
        border-left-color: #dc3545;
    }
    .progress-bar {
        height: 8px;
        border-radius: 4px;
    }
    .status-badge {
        font-size: 0.8em;
        padding: 0.25rem 0.5rem;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .success-rate {
        font-weight: bold;
    }
    .success-rate.high {
        color: #28a745;
    }
    .success-rate.medium {
        color: #ffc107;
    }
    .success-rate.low {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tags"></i> 自动分类记录</h2>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>
            </div>

            <!-- 过滤器 -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label for="batch-type-filter" class="form-label">批次类型</label>
                        <select class="form-select" id="batch-type-filter">
                            <option value="">全部</option>
                            <option value="manual">手动</option>
                            <option value="scheduled">定时</option>
                            <option value="api">API</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status-filter" class="form-label">状态</label>
                        <select class="form-select" id="status-filter">
                            <option value="">全部</option>
                            <option value="running">运行中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date-range-filter" class="form-label">时间范围</label>
                        <select class="form-select" id="date-range-filter">
                            <option value="">全部</option>
                            <option value="today">今天</option>
                            <option value="week">本周</option>
                            <option value="month">本月</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> 应用筛选
                        </button>
                    </div>
                </div>
            </div>

            <!-- 批次列表 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> 分类批次列表</h5>
                </div>
                <div class="card-body">
                    <div id="batches-loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载批次数据...</p>
                    </div>
                    <div id="batches-container" style="display: none;">
                        <!-- 批次列表将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 批次详情模态框 -->
<div class="modal fade" id="batchDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">批次详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="batch-detail-content">
                    <!-- 批次详情将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<!-- 匹配详情模态框 -->
<div class="modal fade" id="matchesModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list"></i> 批次匹配详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="matches-loading" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载匹配详情...</p>
                </div>
                <div id="matches-content" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>批次ID:</strong> <span id="matches-batch-id"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>匹配数量:</strong> <span id="matches-count"></span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>账户信息</th>
                                    <th>实例</th>
                                    <th>分类</th>
                                    <th>匹配规则</th>
                                    <th>命中权限</th>
                                    <th>账户权限</th>
                                    <th>匹配时间</th>
                                </tr>
                            </thead>
                            <tbody id="matches-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="matches-empty" class="text-center py-4 text-muted" style="display: none;">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <p>该批次暂无匹配记录</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentBatches = [];
let currentFilters = {};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadBatches();

    // 设置自动刷新
    setInterval(function() {
        loadBatches();
    }, 30000); // 30秒刷新一次
});


// 加载批次列表
function loadBatches() {
    const params = new URLSearchParams();
    if (currentFilters.batch_type) params.append('batch_type', currentFilters.batch_type);
    if (currentFilters.status) params.append('status', currentFilters.status);

    fetch(`/account-classification/api/batches?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentBatches = data.batches;
                renderBatches(data.batches);
                document.getElementById('batches-loading').style.display = 'none';
                document.getElementById('batches-container').style.display = 'block';
            } else {
                showAlert('加载批次列表失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('加载批次列表出错:', error);
            showAlert('加载批次列表出错', 'danger');
        });
}

// 渲染批次列表
function renderBatches(batches) {
    const container = document.getElementById('batches-container');

    if (batches.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">暂无分类批次</div>';
        return;
    }

    const html = batches.map(batch => {
        const statusClass = getStatusClass(batch.status);
        const statusText = getStatusText(batch.status);
        const successRate = batch.success_rate || 0;
        const successRateClass = getSuccessRateClass(successRate);
        const startedAt = new Date(batch.started_at).toLocaleString();
        const completedAt = batch.completed_at ? new Date(batch.completed_at).toLocaleString() : '-';
        const duration = batch.duration ? Math.round(batch.duration) + '秒' : '-';

        return `
            <div class="card batch-card ${statusClass} mb-3" style="cursor: pointer;" onclick="viewBatchDetail('${batch.batch_id}')">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1">${batch.batch_id.substring(0, 8)}...</h6>
                            <small class="text-muted">${getBatchTypeText(batch.batch_type)}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge status-badge bg-${getStatusColor(batch.status)}">${statusText}</span>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="success-rate ${successRateClass}">${successRate}%</div>
                                <small class="text-muted">成功率</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">
                                总账户: ${batch.total_accounts} |
                                匹配: ${batch.matched_accounts} |
                                失败: ${batch.failed_accounts}
                            </small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${startedAt}<br>
                                <i class="fas fa-stopwatch"></i> ${duration}
                            </small>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12 text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewBatchDetail('${batch.batch_id}')">
                                <i class="fas fa-eye"></i> 查看详情
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); viewBatchMatches('${batch.batch_id}')">
                                <i class="fas fa-list"></i> 查看匹配
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// 查看批次详情
function viewBatchDetail(batchId) {
    fetch(`/account-classification/api/batches/${batchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showBatchDetail(data.batch);
            } else {
                showAlert('加载批次详情失败: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('加载批次详情出错:', error);
            showAlert('加载批次详情出错', 'danger');
        });
}

// 显示批次详情
function showBatchDetail(batch) {
    const content = document.getElementById('batch-detail-content');
    const successRate = batch.success_rate || 0;
    const successRateClass = getSuccessRateClass(successRate);
    const duration = batch.duration ? Math.round(batch.duration) + '秒' : '-';
    const batchDetails = batch.batch_details ? JSON.parse(batch.batch_details) : {};

    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>批次ID:</strong> ${batch.batch_id}
            </div>
            <div class="col-md-6">
                <strong>状态:</strong> <span class="badge bg-${getStatusColor(batch.status)}">${getStatusText(batch.status)}</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>批次类型:</strong> ${getBatchTypeText(batch.batch_type)}
            </div>
            <div class="col-md-6">
                <strong>创建者:</strong> ${batch.created_by ? '用户ID: ' + batch.created_by : '系统'}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>开始时间:</strong> ${new Date(batch.started_at).toLocaleString()}
            </div>
            <div class="col-md-6">
                <strong>完成时间:</strong> ${batch.completed_at ? new Date(batch.completed_at).toLocaleString() : '未完成'}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>总账户数:</strong> ${batch.total_accounts}
            </div>
            <div class="col-md-4">
                <strong>匹配账户:</strong> ${batch.matched_accounts}
            </div>
            <div class="col-md-4">
                <strong>失败账户:</strong> ${batch.failed_accounts}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>总规则数:</strong> ${batch.total_rules}
            </div>
            <div class="col-md-4">
                <strong>活跃规则:</strong> ${batch.active_rules}
            </div>
            <div class="col-md-4">
                <strong>成功率:</strong> <span class="success-rate ${successRateClass}">${successRate}%</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>执行时长:</strong> ${duration}
            </div>
            <div class="col-md-6">
                <strong>实例ID:</strong> ${batchDetails.instance_id || '全部'}
            </div>
        </div>
        ${batch.error_message ? `
            <div class="row mb-3">
                <div class="col-12">
                    <strong>错误信息:</strong>
                    <div class="alert alert-danger mt-2">${batch.error_message}</div>
                </div>
            </div>
        ` : ''}
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary" onclick="viewBatchLogs('${batch.batch_id}')">
                    <i class="fas fa-list"></i> 查看相关日志
                </button>
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('batchDetailModal'));
    modal.show();
}

// 查看批次相关日志
function viewBatchLogs(batchId) {
    // 跳转到日志页面，并过滤显示该批次的日志
    window.open(`/logs/?batch_id=${batchId}`, '_blank');
}

// 查看批次匹配详情
function viewBatchMatches(batchId) {
    const modal = new bootstrap.Modal(document.getElementById('matchesModal'));
    
    // 显示加载状态
    document.getElementById('matches-loading').style.display = 'block';
    document.getElementById('matches-content').style.display = 'none';
    document.getElementById('matches-empty').style.display = 'none';
    
    modal.show();
    
    // 获取匹配详情
    fetch(`/account-classification/api/batches/${batchId}/matches`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('matches-loading').style.display = 'none';
            
            if (data.success) {
                if (data.matches && data.matches.length > 0) {
                    displayMatches(batchId, data.matches);
                } else {
                    document.getElementById('matches-empty').style.display = 'block';
                }
            } else {
                showAlert('加载匹配详情失败: ' + data.error, 'danger');
                modal.hide();
            }
        })
        .catch(error => {
            console.error('加载匹配详情出错:', error);
            showAlert('加载匹配详情出错', 'danger');
            modal.hide();
        });
}

// 显示匹配详情
function displayMatches(batchId, matches) {
    document.getElementById('matches-batch-id').textContent = batchId;
    document.getElementById('matches-count').textContent = matches.length;
    
    const tbody = document.getElementById('matches-table-body');
    tbody.innerHTML = matches.map(match => `
        <tr>
            <td>
                <div>
                    <strong>${match.account_name}</strong>
                    ${match.account_host ? `@${match.account_host}` : ''}
                    <br><small class="text-muted">ID: ${match.account_id}</small>
                    ${match.is_superuser ? '<br><span class="badge bg-danger">超级用户</span>' : ''}
                    ${match.can_grant ? '<br><span class="badge bg-warning">可授权</span>' : ''}
                </div>
            </td>
            <td>
                <div>
                    <strong>${match.instance_name}</strong>
                    <br><span class="badge bg-info">${match.instance_type}</span>
                    <br><small class="text-muted">ID: ${match.instance_id}</small>
                </div>
            </td>
            <td>
                <div>
                    <strong>${match.classification_name}</strong>
                    <br><small class="text-muted">ID: ${match.classification_id}</small>
                </div>
            </td>
            <td>
                <div>
                    <strong>${match.rule_name}</strong>
                    <br><small class="text-muted">ID: ${match.rule_id}</small>
                </div>
            </td>
            <td>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${match.matched_permissions && match.matched_permissions.length > 0 
                        ? match.matched_permissions.map(perm => `
                            <div class="mb-1">
                                <span class="badge bg-success">${perm.name}</span>
                                ${perm.category ? `<br><small class="text-muted">${perm.category}</small>` : ''}
                                ${perm.description ? `<br><small class="text-muted">${perm.description}</small>` : ''}
                            </div>
                        `).join('')
                        : '<small class="text-muted">无权限信息</small>'
                    }
                </div>
            </td>
            <td>
                <div style="max-height: 150px; overflow-y: auto;">
                    ${match.account_permissions && match.account_permissions.length > 0 
                        ? match.account_permissions.map(perm => `
                            <div class="mb-1">
                                <span class="badge ${perm.granted ? 'bg-primary' : 'bg-secondary'}">${perm.name}</span>
                                ${perm.category ? `<br><small class="text-muted">${perm.category}</small>` : ''}
                                ${perm.description ? `<br><small class="text-muted">${perm.description}</small>` : ''}
                            </div>
                        `).join('')
                        : '<small class="text-muted">无权限信息</small>'
                    }
                </div>
            </td>
            <td>
                <small>${match.matched_at ? new Date(match.matched_at).toLocaleString() : '-'}</small>
            </td>
        </tr>
    `).join('');
    
    document.getElementById('matches-content').style.display = 'block';
}

// 应用筛选
function applyFilters() {
    currentFilters = {
        batch_type: document.getElementById('batch-type-filter').value,
        status: document.getElementById('status-filter').value
    };
    loadBatches();
}

// 刷新数据
function refreshData() {
    loadBatches();
}

// 工具函数
function getStatusClass(status) {
    const statusMap = {
        'running': 'running',
        'completed': 'completed',
        'failed': 'failed'
    };
    return statusMap[status] || '';
}

function getStatusText(status) {
    const statusMap = {
        'running': '运行中',
        'completed': '已完成',
        'failed': '失败'
    };
    return statusMap[status] || status;
}

function getStatusColor(status) {
    const colorMap = {
        'running': 'success',
        'completed': 'info',
        'failed': 'danger'
    };
    return colorMap[status] || 'secondary';
}

function getBatchTypeText(type) {
    const typeMap = {
        'manual': '手动',
        'scheduled': '定时',
        'api': 'API'
    };
    return typeMap[type] || type;
}

function getSuccessRateClass(rate) {
    if (rate >= 80) return 'high';
    if (rate >= 50) return 'medium';
    return 'low';
}

// 获取CSRF令牌
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
