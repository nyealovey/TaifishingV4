{% extends "base.html" %}

{% block title %}同步会话管理 - 鲸落{% endblock %}

{% block extra_css %}
<style>
    .session-card {
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }
    .session-card.running {
        border-left-color: #28a745;
    }
    .session-card.completed {
        border-left-color: #17a2b8;
    }
    .session-card.failed {
        border-left-color: #dc3545;
    }
    .session-card.cancelled {
        border-left-color: #6c757d;
    }
    .progress {
        height: 12px;
        border-radius: 6px;
        background-color: #e9ecef;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    .progress-bar {
        height: 12px;
        border-radius: 6px;
        transition: width 0.6s ease;
        position: relative;
        overflow: hidden;
    }
    .progress-bar.bg-success {
        background: linear-gradient(45deg, #28a745, #20c997);
    }
    .progress-bar.bg-danger {
        background: linear-gradient(45deg, #dc3545, #e74c3c);
    }
    .progress-bar.bg-warning {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
    }
    .progress-bar.bg-secondary {
        background: linear-gradient(45deg, #6c757d, #868e96);
    }
    
    /* 进度条动画效果 */
    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-image: linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.2) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0.2) 75%,
            transparent 75%,
            transparent
        );
        background-size: 20px 20px;
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position: 0 0; }
        100% { background-position: 20px 0; }
    }
    
    /* 文本颜色增强 */
    .text-success {
        font-weight: 600;
    }
    .text-danger {
        font-weight: 600;
    }
    .text-warning {
        font-weight: 600;
    }
    .status-badge {
        font-size: 0.8em;
        padding: 0.25rem 0.5rem;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-sync-alt"></i> 同步会话管理</h2>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>
            </div>


            <!-- 过滤器 -->
            <div class="filter-section">
                <div class="row">
                    <div class="col-md-3">
                        <label for="sync-type-filter" class="form-label">同步类型</label>
                        <select class="form-select" id="sync-type-filter">
                            <option value="">全部</option>
                            <option value="manual_single">MANUAL_SINGLE</option>
                            <option value="manual_batch">MANUAL_BATCH</option>
                            <option value="manual_task">MANUAL_TASK</option>
                            <option value="scheduled_task">SCHEDULED_TASK</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sync-category-filter" class="form-label">同步分类</label>
                        <select class="form-select" id="sync-category-filter">
                            <option value="">全部</option>
                            <option value="account">account</option>
                            <option value="capacity">capacity</option>
                            <option value="config">config</option>
                            <option value="other">other</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status-filter" class="form-label">状态</label>
                        <select class="form-select" id="status-filter">
                            <option value="">全部</option>
                            <option value="running">running</option>
                            <option value="completed">completed</option>
                            <option value="failed">failed</option>
                            <option value="cancelled">cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> 应用筛选
                        </button>
                    </div>
                </div>
            </div>

            <!-- 会话列表 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> 同步会话列表</h5>
                </div>
                <div class="card-body">
                    <div id="sessions-loading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载会话数据...</p>
                    </div>
                    <div id="sessions-container" style="display: none;">
                        <!-- 会话列表将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 会话详情模态框 -->
<div class="modal fade" id="sessionDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">会话详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="session-detail-content">
                    <!-- 会话详情将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 错误日志模态框 -->
<div class="modal fade" id="errorLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>错误
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="error-logs-content">
                    <!-- 错误日志将在这里动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 全局变量
let currentSessions = [];
let currentFilters = {};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();

    // 设置自动刷新
    setInterval(function() {
        loadSessions();
    }, 30000); // 30秒刷新一次
});


// 加载会话列表
function loadSessions() {
    const params = new URLSearchParams();
    if (currentFilters.sync_type) params.append('sync_type', currentFilters.sync_type);
    if (currentFilters.sync_category) params.append('sync_category', currentFilters.sync_category);
    if (currentFilters.status) params.append('status', currentFilters.status);

    fetch(`/sync_sessions/api/sessions?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentSessions = data.data;
                renderSessions(data.data);
                document.getElementById('sessions-loading').style.display = 'none';
                document.getElementById('sessions-container').style.display = 'block';
            } else {
                showAlert('danger', '加载会话列表失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('加载会话列表出错:', error);
            showAlert('danger', '加载会话列表出错');
        });
}

// 渲染会话列表
function renderSessions(sessions) {
    const container = document.getElementById('sessions-container');

    if (sessions.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">暂无同步会话</div>';
        return;
    }

    const html = sessions.map(session => {
        const statusClass = getStatusClass(session.status);
        const statusText = getStatusText(session.status);
        const startedAt = formatTime(session.started_at, 'datetime');
        const completedAt = session.completed_at ? formatTime(session.completed_at, 'datetime') : '-';
        
        // 计算成功率和进度条样式
        const totalInstances = session.total_instances || 0;
        const successfulInstances = session.successful_instances || 0;
        const failedInstances = session.failed_instances || 0;
        const successRate = totalInstances > 0 ? Math.round((successfulInstances / totalInstances) * 100) : 0;
        
        // 根据成功率确定进度条颜色和样式
        const progressInfo = getProgressInfo(successRate, totalInstances, successfulInstances, failedInstances);

        return `
            <div class="card session-card ${statusClass} mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <h6 class="mb-1">${session.session_id.substring(0, 8)}...</h6>
                            <small class="text-muted">${getSyncTypeText(session.sync_type)} - ${getSyncCategoryText(session.sync_category)}</small>
                        </div>
                        <div class="col-md-2">
                            <span class="badge status-badge bg-${getStatusColor(session.status)}">${statusText}</span>
                        </div>
                        <div class="col-md-3">
                            <div class="progress" style="height: 12px;">
                                <div class="progress-bar ${progressInfo.barClass}" 
                                     role="progressbar" 
                                     style="width: ${successRate}%"
                                     title="${progressInfo.tooltip}">
                                </div>
                            </div>
                            <small class="text-muted">
                                <span class="${progressInfo.textClass}">
                                    <i class="${progressInfo.icon}"></i> ${successRate}% (${successfulInstances}/${totalInstances})
                                </span>
                            </small>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${startedAt}<br>
                                <i class="fas fa-check-circle"></i> ${completedAt}
                            </small>
                        </div>
                        <div class="col-md-1">
                            ${getDurationBadge(session.started_at, session.completed_at)}
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewSessionDetail('${session.session_id}')">
                                <i class="fas fa-eye"></i> 详情
                            </button>
                            ${failedInstances > 0 ? `
                                <button class="btn btn-sm btn-outline-warning" onclick="viewErrorLogs('${session.session_id}')" title="查看错误">
                                    <i class="fas fa-exclamation-triangle"></i> 错误
                                </button>
                            ` : ''}
                            ${session.status === 'running' ? `
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelSession('${session.session_id}')">
                                    <i class="fas fa-stop"></i> 取消
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

// 查看会话详情
function viewSessionDetail(sessionId) {
    fetch(`/sync_sessions/api/sessions/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSessionDetail(data.data);
            } else {
                showAlert('danger', '加载会话详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('加载会话详情出错:', error);
            showAlert('danger', '加载会话详情出错');
        });
}

// 查看错误日志
function viewErrorLogs(sessionId) {
    fetch(`/sync_sessions/api/sessions/${sessionId}/error-logs`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showErrorLogs(data.data);
            } else {
                showAlert('danger', '加载错误信息失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('加载错误信息出错:', error);
            showAlert('danger', '加载错误信息出错');
        });
}

// 显示错误日志
function showErrorLogs(data) {
    const content = document.getElementById('error-logs-content');
    const errorRecords = data.error_records || [];

    if (errorRecords.length === 0) {
        content.innerHTML = '<div class="text-center py-4 text-muted">没有发现错误记录</div>';
    } else {
        const recordsHtml = errorRecords.map(record => {
            return `
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${record.instance_name} (ID: ${record.instance_id})
                        </h6>
                    </div>
                    <div class="card-body">
                        ${record.error_message ? `
                            <div class="alert alert-danger mb-0">
                                <h6 class="alert-heading">
                                    <i class="fas fa-bug me-2"></i>错误信息
                                </h6>
                                <pre class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">${record.error_message}</pre>
                            </div>
                        ` : '<div class="text-muted">没有具体错误信息</div>'}
                    </div>
                </div>
            `;
        }).join('');

        content.innerHTML = recordsHtml;
    }

    // 显示错误日志模态框
    const modal = new bootstrap.Modal(document.getElementById('errorLogsModal'));
    modal.show();
}

// 显示会话详情
function showSessionDetail(session) {
    const content = document.getElementById('session-detail-content');
    const records = session.instance_records || [];

    const recordsHtml = records.map(record => {
        const statusClass = getStatusClass(record.status);
        const statusText = getStatusText(record.status);
        const duration = record.started_at && record.completed_at ?
            Math.round((new Date(record.completed_at) - new Date(record.started_at)) / 1000) + '秒' : '-';
        const startedAt = formatTime(record.started_at, 'datetime');
        const completedAt = record.completed_at ? formatTime(record.completed_at, 'datetime') : '-';

        return `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <h6 class="mb-1"><strong>ID: ${record.instance_id}</strong> &nbsp;&nbsp; ${record.instance_name}</h6>
                        </div>
                        <div class="col-md-2">
                            <span class="badge status-badge bg-${getStatusColor(record.status)}">${statusText}</span>
                        </div>
                        <div class="col-md-7">
                            <small class="text-muted">
                                开始: ${startedAt} &nbsp;&nbsp; | &nbsp;&nbsp; 完成: ${completedAt} &nbsp;&nbsp; | &nbsp;&nbsp; 耗时: ${duration}
                                ${record.error_message ? ` &nbsp;&nbsp; | &nbsp;&nbsp; 错误: ${record.error_message}` : ''}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    content.innerHTML = `
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>会话ID:</strong> ${session.session_id}
            </div>
            <div class="col-md-6">
                <strong>状态:</strong> <span class="badge bg-${getStatusColor(session.status)}">${getStatusText(session.status)}</span>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>同步类型:</strong> ${getSyncTypeText(session.sync_type)}
            </div>
            <div class="col-md-6">
                <strong>同步分类:</strong> ${getSyncCategoryText(session.sync_category)}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <strong>开始时间:</strong> ${formatTime(session.started_at, 'datetime')}
            </div>
            <div class="col-md-6">
                <strong>完成时间:</strong> ${session.completed_at ? formatTime(session.completed_at, 'datetime') : '未完成'}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>总实例数:</strong> ${session.total_instances}
            </div>
            <div class="col-md-4">
                <strong>成功:</strong> ${session.successful_instances}
            </div>
            <div class="col-md-4">
                <strong>失败:</strong> ${session.failed_instances}
            </div>
        </div>
        <hr>
        <h6>实例记录</h6>
        <div class="max-height-400 overflow-auto">
            ${recordsHtml || '<div class="text-muted">暂无实例记录</div>'}
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('sessionDetailModal'));
    modal.show();
}

// 取消会话
function cancelSession(sessionId) {
    if (confirm('确定要取消这个同步会话吗？')) {
        fetch(`/sync_sessions/api/sessions/${sessionId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', '会话已取消');
                loadSessions();
            } else {
                showAlert('danger', '取消会话失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('取消会话出错:', error);
            showAlert('danger', '取消会话出错');
        });
    }
}

// 应用筛选
function applyFilters() {
    currentFilters = {
        sync_type: document.getElementById('sync-type-filter').value,
        sync_category: document.getElementById('sync-category-filter').value,
        status: document.getElementById('status-filter').value
    };
    loadSessions();
}

// 刷新数据
function refreshData() {
    loadSessions();
}

// 获取进度条信息
function getProgressInfo(successRate, totalInstances, successfulInstances, failedInstances) {
    if (totalInstances === 0) {
        return {
            barClass: 'bg-secondary',
            textClass: 'text-muted',
            icon: 'fas fa-question-circle',
            tooltip: '无实例数据'
        };
    }
    
    if (successRate === 100) {
        return {
            barClass: 'bg-success',
            textClass: 'text-success',
            icon: 'fas fa-check-circle',
            tooltip: '全部成功'
        };
    } else if (successRate === 0) {
        return {
            barClass: 'bg-danger',
            textClass: 'text-danger',
            icon: 'fas fa-times-circle',
            tooltip: '全部失败'
        };
    } else if (successRate >= 70) {
        return {
            barClass: 'bg-warning',
            textClass: 'text-warning',
            icon: 'fas fa-exclamation-triangle',
            tooltip: `部分成功 (${successfulInstances}成功, ${failedInstances}失败)`
        };
    } else {
        return {
            barClass: 'bg-danger',
            textClass: 'text-danger',
            icon: 'fas fa-exclamation-triangle',
            tooltip: `大部分失败 (${successfulInstances}成功, ${failedInstances}失败)`
        };
    }
}

// 工具函数
function getStatusClass(status) {
    const statusMap = {
        'running': 'running',
        'completed': 'completed',
        'failed': 'failed',
        'cancelled': 'cancelled'
    };
    return statusMap[status] || '';
}

function getStatusText(status) {
    // 直接返回原始状态值（英文）
    return status;
}

function getStatusColor(status) {
    const colorMap = {
        'running': 'success',
        'completed': 'info',
        'failed': 'danger',
        'cancelled': 'secondary',
        'pending': 'warning'
    };
    return colorMap[status] || 'secondary';
}

function getSyncTypeText(type) {
    // 直接返回原始类型值（英文）
    return type;
}

function getSyncCategoryText(category) {
    // 直接返回原始分类值（英文）
    return category;
}

// 使用统一的时间格式化函数
// formatChinaTime 函数已由 time-utils.js 提供

// 获取耗时徽章
function getDurationBadge(startedAt, completedAt) {
    if (!startedAt || !completedAt) {
        return '<span class="text-muted">-</span>';
    }
    
    const startTime = new Date(startedAt);
    const endTime = new Date(completedAt);
    const duration = (endTime - startTime) / 1000; // 转换为秒
    
    if (duration < 60) {
        return `<span class="badge bg-info">${duration.toFixed(1)}秒</span>`;
    } else if (duration < 3600) {
        return `<span class="badge bg-info">${(duration / 60).toFixed(1)}分钟</span>`;
    } else {
        return `<span class="badge bg-info">${(duration / 3600).toFixed(1)}小时</span>`;
    }
}

// 获取CSRF令牌
function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
</script>
{% endblock %}
