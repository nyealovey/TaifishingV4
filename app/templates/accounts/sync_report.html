{% extends "base.html" %}

{% block title %}同步报告 - 泰摸鱼吧{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>同步报告</h2>
        <div>
            <a href="{{ url_for('accounts.list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>返回账户管理
            </a>
        </div>
    </div>

    <!-- 统计信息卡片 -->
    <div class="row mb-4" id="statisticsCards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalSyncs">0</h4>
                            <p class="card-text">总同步次数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-sync fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="successRate">0%</h4>
                            <p class="card-text">同步成功率</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title" id="totalAccounts">0</h4>
                            <p class="card-text">总同步账户数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title" id="lastSyncTime">-</h6>
                            <p class="card-text">最近同步时间</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 趋势图表 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>同步趋势（最近7天）
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="syncTrendChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步历史清单 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>同步历史
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>执行时间</th>
                            <th>同步类型</th>
                            <th>总实例数</th>
                            <th>成功</th>
                            <th>失败</th>
                            <th>同步账户数</th>
                            <th>新增账户</th>
                            <th>删除账户</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="syncHistoryBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted">暂无同步记录</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 当前同步结果 -->
    <div id="currentSyncResult" class="card mb-4" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-sync me-2"></i>当前同步结果
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title" id="totalInstances">0</h4>
                                    <p class="card-text">总实例数</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-server fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title" id="successInstances">0</h4>
                                    <p class="card-text">成功同步</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title" id="failedInstances">0</h4>
                                    <p class="card-text">同步失败</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title" id="totalAccounts">0</h4>
                                    <p class="card-text">同步账户数</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <h6>详细结果：</h6>
                <div id="syncDetails" class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>实例名称</th>
                                <th>状态</th>
                                <th>消息</th>
                                <th>同步账户数</th>
                            </tr>
                        </thead>
                        <tbody id="syncDetailsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

function loadSyncHistory() {
    // 加载同步历史记录
    fetch('/accounts/sync-history')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySyncHistory(data.history);
        } else {
            console.error('加载同步历史失败:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
    
    // 加载统计信息
    loadStatistics();
}

function loadStatistics() {
    fetch('/accounts/sync-statistics')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatistics(data.statistics);
            createCharts(data.trend_data, data.db_type_distribution);
        } else {
            console.error('加载统计信息失败:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function updateStatistics(statistics) {
    // 更新统计卡片
    document.getElementById('totalSyncs').textContent = statistics.total_syncs;
    document.getElementById('successRate').textContent = statistics.success_rate + '%';
    document.getElementById('totalAccounts').textContent = statistics.total_accounts;
    document.getElementById('lastSyncTime').textContent = statistics.last_sync_time || '-';
}

function createCharts(trendData, dbTypeDistribution) {
    // 创建同步趋势图表
    createSyncTrendChart(trendData);
}

function createSyncTrendChart(trendData) {
    const ctx = document.getElementById('syncTrendChart').getContext('2d');
    
    // 按日期排序（从早到晚）
    const sortedData = trendData.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: sortedData.map(d => d.date),
            datasets: [
                {
                    label: '成功同步',
                    data: sortedData.map(d => d.success),
                    borderColor: 'rgb(40, 167, 69)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1
                },
                {
                    label: '同步失败',
                    data: sortedData.map(d => d.failed),
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.1
                },
                {
                    label: '同步账户数',
                    data: sortedData.map(d => d.accounts),
                    borderColor: 'rgb(23, 162, 184)',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '同步次数'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '账户数量'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false
                }
            }
        }
    });
}


function getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
    }
    return days;
}

function displaySyncHistory(history) {
    const tbody = document.getElementById('syncHistoryBody');
    tbody.innerHTML = '';
    
    if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无同步记录</td></tr>';
        return;
    }
    
    history.forEach(record => {
        const row = document.createElement('tr');
        
        // 根据同步类型设置样式
        let syncTypeBadge = '';
        if (record.sync_type === '定时任务') {
            syncTypeBadge = '<span class="badge bg-primary"><i class="fas fa-clock me-1"></i>定时任务</span>';
        } else if (record.sync_type === '手动执行') {
            syncTypeBadge = '<span class="badge bg-info"><i class="fas fa-hand-pointer me-1"></i>手动执行</span>';
        } else if (record.sync_type === '定时任务 + 手动执行') {
            syncTypeBadge = '<span class="badge bg-warning"><i class="fas fa-clock me-1"></i>定时任务 + 手动执行</span>';
        } else {
            syncTypeBadge = '<span class="badge bg-secondary">未知</span>';
        }
        
        row.innerHTML = `
            <td>${record.created_at}</td>
            <td>${syncTypeBadge}</td>
            <td>${record.total_instances}</td>
            <td><span class="badge bg-success">${record.success_count}</span></td>
            <td><span class="badge bg-danger">${record.failed_count}</span></td>
            <td>${record.total_accounts}</td>
            <td><span class="badge bg-info">${record.added_count || 0}</span></td>
            <td><span class="badge bg-warning">${record.removed_count || 0}</span></td>
            <td>
                <button type="button" class="btn btn-outline-primary btn-sm" 
                        onclick="viewSyncDetails('${record.id}')" title="查看详情">
                    <i class="fas fa-eye me-1"></i>详情
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function viewSyncDetails(syncId) {
    // 查看同步详情
    fetch(`/accounts/sync-details/${syncId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSyncDetailsModal(data.details);
        } else {
            showAlert('danger', data.error || '获取详情失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', '获取详情失败');
    });
}

function showSyncDetailsModal(details) {
    // 创建详情模态框
    const modalHtml = `
        <div class="modal fade" id="syncDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-info-circle me-2"></i>同步详情
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- 统计信息 -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">${details.reduce((sum, d) => sum + (d.synced_count || 0), 0)}</h5>
                                        <p class="card-text">同步账户数</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">${details.reduce((sum, d) => sum + (d.added_count || 0), 0)}</h5>
                                        <p class="card-text">新增账户</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">${details.reduce((sum, d) => sum + (d.removed_count || 0), 0)}</h5>
                                        <p class="card-text">删除账户</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">${details.reduce((sum, d) => sum + (d.modified_count || 0), 0)}</h5>
                                        <p class="card-text">修改账户</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 实例详情表格 -->
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>实例名称</th>
                                        <th>状态</th>
                                        <th>消息</th>
                                        <th>同步账户数</th>
                                        <th>新增</th>
                                        <th>删除</th>
                                        <th>修改</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${details.map(detail => `
                                        <tr>
                                            <td>${detail.instance_name}</td>
                                            <td>
                                                <span class="badge ${detail.success ? 'bg-success' : 'bg-danger'}">
                                                    ${detail.success ? '成功' : '失败'}
                                                </span>
                                            </td>
                                            <td>${detail.message}</td>
                                            <td>${detail.synced_count || 0}</td>
                                            <td><span class="badge bg-success">${detail.added_count || 0}</span></td>
                                            <td><span class="badge bg-warning">${detail.removed_count || 0}</span></td>
                                            <td><span class="badge bg-info">${detail.modified_count || 0}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 账户变化详情 -->
                        ${details.some(d => d.account_changes && d.account_changes.length > 0) ? `
                        <div class="mt-4">
                            <h6>账户变化详情：</h6>
                            ${details.map(detail => detail.account_changes && detail.account_changes.length > 0 ? `
                                <div class="mb-3">
                                    <h6 class="text-primary">${detail.instance_name}</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>变化类型</th>
                                                    <th>用户名</th>
                                                    <th>主机</th>
                                                    <th>数据库</th>
                                                    <th>插件</th>
                                                    <th>状态</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${detail.account_changes.map(change => `
                                                    <tr>
                                                        <td>
                                                            <span class="badge ${
                                                                change.change_type === 'added' ? 'bg-success' : 
                                                                change.change_type === 'removed' ? 'bg-danger' : 'bg-info'
                                                            }">
                                                                ${change.change_type === 'added' ? '新增' : 
                                                                  change.change_type === 'removed' ? '删除' : '修改'}
                                                            </span>
                                                        </td>
                                                        <td>${change.account_data.username || '-'}</td>
                                                        <td>${change.account_data.host || '-'}</td>
                                                        <td>${change.account_data.database_name || '-'}</td>
                                                        <td>${change.account_data.plugin || '-'}</td>
                                                        <td>
                                                            ${change.account_data.is_locked ? '<span class="badge bg-danger">锁定</span>' : ''}
                                                            ${change.account_data.password_expired ? '<span class="badge bg-warning">密码过期</span>' : ''}
                                                            ${!change.account_data.is_locked && !change.account_data.password_expired ? '<span class="badge bg-success">正常</span>' : ''}
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : '').join('')}
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除现有模态框
    const existingModal = document.getElementById('syncDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('syncDetailsModal'));
    modal.show();
}

function displaySyncReport(report) {
    // 显示当前同步结果区域
    document.getElementById('currentSyncResult').style.display = 'block';
    
    // 更新统计数字
    document.getElementById('totalInstances').textContent = report.total_instances;
    document.getElementById('successInstances').textContent = report.success_count;
    document.getElementById('failedInstances').textContent = report.failed_count;
    document.getElementById('totalAccounts').textContent = report.total_accounts;
    
    // 更新详细结果表格
    const tbody = document.getElementById('syncDetailsBody');
    tbody.innerHTML = '';
    
    report.results.forEach(result => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${result.instance_name}</td>
            <td>
                <span class="badge ${result.success ? 'bg-success' : 'bg-danger'}">
                    ${result.success ? '成功' : '失败'}
                </span>
            </td>
            <td>${result.message}</td>
            <td>${result.synced_count || 0}</td>
        `;
        tbody.appendChild(row);
    });
    
    // 重新加载同步历史
    loadSyncHistory();
    
    // 滚动到同步结果
    document.getElementById('currentSyncResult').scrollIntoView({ behavior: 'smooth' });
}

// 页面加载时自动加载同步历史
document.addEventListener('DOMContentLoaded', function() {
    loadSyncHistory();
});
</script>
{% endblock %}
