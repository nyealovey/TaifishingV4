---
inclusion: always
---

## ERROR_HANDLING

### Guidelines for PYTHON

#### EXCEPTION_HANDLING

- **避免裸露的except语句**: 必须指定具体的异常类型，不要使用裸露的except
- **记录详细错误信息**: 使用logging记录异常详情，包括堆栈跟踪
- **实现优雅降级**: 当非关键功能失败时，应用应该继续运行
- **使用适当的异常类型**: 选择最具体的异常类型，避免滥用Exception
- **实现错误恢复**: 对于可恢复的错误，实现重试机制
- **避免try-except-pass**: 不要忽略异常，至少要记录错误信息

#### ERROR_LOGGING

- **结构化日志记录**: 使用JSON格式记录错误，便于分析和监控
- **包含上下文信息**: 记录用户ID、请求ID、操作类型等上下文
- **使用适当的日志级别**: ERROR用于系统错误，WARNING用于可恢复问题
- **避免敏感信息**: 不在日志中记录密码、令牌等敏感信息
- **实现日志轮转**: 防止日志文件过大，定期归档旧日志

#### VALIDATION_ERRORS

- **输入验证**: 在数据进入系统时进行严格验证
- **使用Pydantic**: 使用Pydantic进行数据验证和序列化
- **返回具体错误**: 提供具体的验证错误信息，帮助用户修正
- **实现错误聚合**: 收集所有验证错误，一次性返回给用户
- **使用错误码**: 为不同类型的验证错误定义唯一错误码

#### DATABASE_ERRORS

- **连接错误处理**: 处理数据库连接失败、超时等错误
- **事务回滚**: 在发生错误时正确回滚数据库事务
- **重试机制**: 对临时性数据库错误实现指数退避重试
- **连接池管理**: 正确处理连接池中的连接错误
- **记录SQL错误**: 记录SQL执行错误，便于调试

#### API_ERRORS

- **统一错误格式**: 使用统一的JSON错误响应格式
- **HTTP状态码**: 使用适当的HTTP状态码表示错误类型
- **错误消息国际化**: 支持多语言错误消息
- **错误追踪**: 为每个错误生成唯一追踪ID
- **API限流错误**: 实现API限流，返回429状态码

#### BUSINESS_LOGIC_ERRORS

- **自定义异常类**: 为业务逻辑错误定义专门的异常类
- **错误分类**: 将错误分为系统错误、业务错误、用户错误等
- **错误传播**: 在适当的层级处理错误，避免过度传播
- **错误转换**: 将底层技术错误转换为用户友好的业务错误
- **错误恢复**: 实现业务逻辑的错误恢复机制

#### RESOURCE_ERRORS

- **文件操作错误**: 处理文件不存在、权限不足、磁盘空间不足等错误
- **网络错误**: 处理网络超时、连接失败、DNS解析失败等错误
- **内存错误**: 处理内存不足、内存泄漏等错误
- **资源清理**: 在发生错误时正确清理已分配的资源
- **资源监控**: 监控资源使用情况，预防资源耗尽

#### CONCURRENCY_ERRORS

- **线程安全**: 确保多线程环境下的数据一致性
- **死锁预防**: 避免死锁，使用超时机制
- **竞态条件**: 识别和修复竞态条件
- **锁管理**: 正确使用锁，避免锁泄漏
- **异步错误**: 正确处理异步操作中的错误

#### EXTERNAL_SERVICE_ERRORS

- **服务不可用**: 处理外部服务不可用的情况
- **超时处理**: 设置合理的超时时间，避免长时间等待
- **重试策略**: 实现指数退避重试策略
- **熔断器模式**: 使用熔断器模式防止级联失败
- **降级服务**: 在外部服务不可用时提供降级服务

#### ERROR_MONITORING

- **错误统计**: 统计各种错误的发生频率和趋势
- **告警机制**: 当错误率超过阈值时发送告警
- **错误分析**: 分析错误模式，识别系统性问题
- **性能影响**: 监控错误对系统性能的影响
- **用户影响**: 评估错误对用户体验的影响

#### ERROR_RECOVERY

- **自动恢复**: 实现自动错误恢复机制
- **手动干预**: 为无法自动恢复的错误提供手动干预接口
- **数据修复**: 实现数据一致性检查和修复
- **服务重启**: 在必要时重启服务以恢复状态
- **回滚机制**: 实现操作回滚，恢复到错误前的状态

#### ERROR_TESTING

- **异常测试**: 编写测试用例验证异常处理逻辑
- **错误注入**: 使用错误注入测试系统的容错能力
- **边界测试**: 测试边界条件下的错误处理
- **压力测试**: 在高负载下测试错误处理
- **故障测试**: 模拟各种故障场景测试系统响应

#### ERROR_DOCUMENTATION

- **错误码文档**: 维护完整的错误码和错误消息文档
- **故障排除指南**: 提供常见错误的故障排除指南
- **错误处理流程**: 文档化错误处理的流程和责任人
- **监控指标**: 文档化错误监控的指标和阈值
- **最佳实践**: 总结错误处理的最佳实践和经验教训
